{% extends "base.html" %}

{% block styles %}
<style type="text/css">
    /* General Page Styles */
    .account-overview-container {
        padding: 0; /* Use main-content padding from base.html */
    }

    .page-header h2 { /* Using a class for the header for more specific styling */
        font-size: 2.25rem; /* Slightly adjusted from base page-title */
        font-weight: 700;
        color: var(--accent-color);
        margin-bottom: 2rem;
        font-family: 'Inter', sans-serif;
    }

    /* Balance Box - Enhanced */
    .balance-box-wrapper {
        margin-bottom: 2.5rem;
    }

    .balance-box {
        background: var(--balance-bg); /* Use theme variable */
        padding: 2rem 2.5rem; /* Increased padding */
        border: 1px solid transparent; /* Keep border for structure, make transparent initially */
        border-radius: 1rem; /* Consistent with other elements */
        box-shadow: var(--balance-outer-shadow); /* Use theme variable */
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        font-family: 'Inter', sans-serif; /* Consistent font */
        position: relative;
        overflow: hidden;
    }

    .balance-box::before { /* Subtle decorative element */
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(var(--accent-color-rgb), 0.05) 0%, rgba(var(--accent-color-rgb), 0) 70%);
        opacity: 0;
        transition: opacity 0.5s ease;
        z-index: 0;
    }

    .balance-box:hover::before {
        opacity: 1;
    }

    .balance-box:hover {
        transform: translateY(-5px); /* More subtle hover */
        box-shadow: 0 12px 28px rgba(var(--accent-color-rgb), 0.2), var(--balance-inner-shadow);
    }

    .balance-content { /* Wrapper for content to be above pseudo-element */
        position: relative;
        z-index: 1;
    }

    .balance-title {
        font-size: 1.1rem; /* Slightly smaller for "Current Balance" */
        font-weight: 500;
        color: var(--text-color);
        opacity: 0.8;
        margin-bottom: 0.5rem;
    }

    .balance-amount-wrapper {
        display: flex;
        align-items: center;
        gap: 0.75rem; /* Space between icon and amount */
    }

    .balance-icon {
        font-size: 2.5rem;
        color: var(--accent-color);
    }

    .balance-amount {
        font-size: 2.75rem; /* Larger amount */
        font-weight: 550;
        color: var(--text-color);
        line-height: 1.2;
        margin-left: 0.5rem;
    }


    /* Action Buttons - Replaced and Restyled */
    .action-buttons-wrapper {
        display: flex;
        gap: 1rem; /* Spacing between buttons */
        align-items: center; /* Align items if heights differ */
    }

    .btn-action { /* Common style for new action buttons */
        padding: 0.875rem 1.75rem; /* Adjusted padding */
        font-size: 1rem; /* Standardized font size */
        font-weight: 600;
        border-radius: 0.75rem; /* Consistent rounding */
        transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, border-color 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.6rem; /* Space between icon and text */
        line-height: 1.5;
    }

    .btn-action i.bi {
        font-size: 1.25rem; /* Icon size */
    }

    .btn-action.btn-primary { /* Using existing .btn-primary from base.html for one */
        /* Styles inherited from base.html */
    }

    .btn-action.btn-outline-secondary { /* New style for the other button */
        background-color: transparent;
        border: 2px solid var(--accent-color);
        color: var(--accent-color);
    }

    .btn-action.btn-outline-secondary:hover {
        background-color: rgba(var(--accent-color-rgb), 0.1);
        border-color: var(--accent-color-hover);
        color: var(--accent-color-hover);
        transform: translateY(-2px);
        box-shadow: 0 3px 7px rgba(var(--accent-color-rgb), 0.15);
    }

    [data-bs-theme="dark"] .btn-action.btn-outline-secondary {
        border-color: var(--accent-color);
        color: var(--accent-color);
    }

    [data-bs-theme="dark"] .btn-action.btn-outline-secondary:hover {
        background-color: rgba(var(--accent-color-rgb), 0.15);
        border-color: var(--accent-color-hover);
        color: var(--accent-color-hover);
    }


    /* Section Toggles (for Transactions/Deposits) - Enhanced */
    .section-toggle {
        color: var(--text-color); /* Use text color, accent for icon */
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        width: 100%;
        padding: 1rem 1.5rem;
        background: var(--balance-bg); /* Use a consistent background, similar to balance box */
        border-radius: 0.75rem;
        font-family: 'Inter', sans-serif;
        margin-bottom: 1rem; /* Space before the list */
        box-shadow: 0 2px 5px rgba(var(--accent-color-rgb), 0.08);
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
    }

    .section-toggle:hover {
        background-color: rgba(var(--accent-color-rgb), 0.05); /* Subtle hover */
        box-shadow: 0 4px 8px rgba(var(--accent-color-rgb), 0.12);
    }

    [data-bs-theme="dark"] .section-toggle:hover {
        background-color: rgba(var(--accent-color-rgb), 0.1);
    }


    .section-toggle h3 {
        margin: 0;
        font-size: 1.25rem; /* Adjusted size */
        font-weight: 600;
        color: var(--text-color); /* Main text color */
    }

    .section-toggle i.bi-chevron-down { /* Chevron icon */
        font-size: 1.25rem;
        color: var(--accent-color);
        transition: transform 0.3s ease;
    }

    .section-toggle i.bi-chevron-down.up {
        transform: rotate(180deg);
    }

    /* Transaction/Deposit List Styling - Enhanced */
    .items-list-container { /* Wrapper for each list (transactions, deposits) */
        margin-bottom: 2.5rem; /* Space between sections */
    }

    .items-list { /* Common class for transaction and deposit lists */
        background-color: var(--background-color); /* Match page background or slightly off */
        border-radius: 0.75rem;
        /* box-shadow: 0 1px 3px rgba(var(--accent-color-rgb), 0.05); */ /* Optional subtle shadow for list container */
        overflow: hidden; /* Important for max-height transition */
        max-height: 0; /* Initially hidden for toggle */
        opacity: 0;
        transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out, padding-top 0.5s ease-in-out, padding-bottom 0.5s ease-in-out;
        padding-top: 0;
        padding-bottom: 0;
    }

    .items-list.show { /* Class to show the list */
        max-height: 2500px; /* Large enough for content */
        opacity: 1;
        padding-top: 1rem; /* Padding when shown */
        padding-bottom: 1rem;
    }

    .item-entry { /* Replaces .transaction-item for common styling */
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--bs-border-color); /* Separator */
        transition: background-color 0.2s ease;
        cursor: pointer;
        font-family: 'Inter', sans-serif;
    }

    .item-entry:last-child {
        border-bottom: none;
    }

    .item-entry:hover {
        background-color: rgba(var(--accent-color-rgb), 0.03);
    }

    [data-bs-theme="dark"] .item-entry:hover {
        background-color: rgba(var(--accent-color-rgb), 0.08);
    }

    .item-entry .date,
    .item-entry .description, /* Renamed from .status for deposits for consistency */
    .item-entry .status { /* Keep .status if needed for specific transaction types */
        font-size: 0.95rem; /* Adjusted size */
        color: var(--text-color);
        opacity: 0.9;
        flex-basis: 30%; /* Distribute space */
    }

    .item-entry .description {
        flex-grow: 1; /* Allow description to take more space */
    }

    .item-entry .amount {
        font-size: 1rem;
        font-weight: 600; /* Bolder amount */
        color: var(--bs-danger); /* Default to danger color */
        min-width: 100px; /* Ensure alignment */
        text-align: right;
        flex-basis: 20%;
    }

    .item-entry .amount.positive {
        color: var(--bs-success);
    }

    .item-entry .info-icon {
        font-size: 1.1rem; /* Adjusted size */
        color: var(--accent-color);
        opacity: 0.7;
        transition: opacity 0.2s ease;
        flex-basis: 10%;
        text-align: right;
    }

    .item-entry:hover .info-icon {
        opacity: 1;
    }

    /* Loading Container for lists */
    .list-loading-container {
        font-size: 1.5rem; /* Smaller spinner for lists */
        text-align: center;
        width: 100%;
        display: flex;
        color: var(--accent-color);
        justify-content: center;
        align-items: center;
        margin: 1rem auto;
        padding: 1rem 0;
        min-height: 80px; /* Give some space for spinner */
        opacity: 1;
        transition: opacity 0.3s ease-in-out, max-height 0.3s ease-in-out;
    }

    .list-loading-container.hidden {
        opacity: 0;
        max-height: 0;
        padding: 0;
        margin: 0;
        overflow: hidden;
    }

    .list-loading-container .bi-arrow-repeat {
        animation: spin 1.2s linear infinite; /* Consistent spin animation */
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }

    /* "View More" Button for lists */
    .view-more-button-container { /* Wrapper for centering */
        text-align: center;
        padding-top: 1rem; /* Space above button if list is short */
    }

    .btn-view-more { /* Common class for view more buttons */
        /* Using .btn-outline-primary from base.html */
    }


    /* Modal Styling - Inherits from base.html, minor adjustments if needed */
    .modal-content {
        font-family: 'Inter', sans-serif; /* Consistent font */
        background: var(--background-color); /* Use page background for modal */
        border: 1px solid var(--bs-border-color);
        border-radius: 0.75rem;
    }

    .modal-header {
        border-bottom: 1px solid var(--bs-border-color);
        padding: 1rem 1.5rem;
    }

    .modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-color);
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-body p {
        font-size: 1rem;
        color: var(--text-color);
        margin-bottom: 0.75rem;
    }

    .modal-body p strong {
        font-weight: 600;
        color: var(--accent-color);
    }

    .modal-footer {
        border-top: 1px solid var(--bs-border-color);
        padding: 1rem 1.5rem;
    }

    .modal-footer .btn { /* General modal button styling */
        font-size: 0.95rem;
        padding: 0.6rem 1.2rem;
    }

    /* Responsive Adjustments */
    @media (max-width: 991.98px) {
        /* Tablet */
        .balance-box-wrapper .row > div:first-child {
            margin-bottom: 1.5rem; /* Space between balance and buttons on stack */
        }

        .action-buttons-wrapper {
            justify-content: flex-start; /* Align buttons to start on stack */
        }
    }

    @media (max-width: 767.98px) {
        /* Mobile */
        .page-header h2 {
            font-size: 1.8rem;
        }

        .balance-box {
            padding: 1.5rem;
        }

        .balance-amount {
            font-size: 2.25rem;
        }

        .action-buttons-wrapper {
            flex-direction: column; /* Stack buttons */
            align-items: stretch; /* Make buttons full width */
        }

        .btn-action {
            width: 100%;
            justify-content: center; /* Center content in full-width button */
            margin-bottom: 0.75rem; /* Space when stacked */
        }

        .action-buttons-wrapper .btn-action:last-child {
            margin-bottom: 0;
        }

        .section-toggle h3 {
            font-size: 1.1rem;
        }

        .item-entry {
            padding: 0.8rem 1rem;
            flex-wrap: wrap; /* Allow wrapping for smaller screens */
        }

        .item-entry .date, .item-entry .description, .item-entry .status {
            font-size: 0.85rem;
            flex-basis: 45%; /* Adjust basis for wrapping */
            margin-bottom: 0.25rem;
        }

        .item-entry .amount {
            font-size: 0.9rem;
            flex-basis: 100%; /* Amount takes full width below */
            text-align: left; /* Align left when wrapped */
            margin-top: 0.25rem;
        }

        .item-entry .info-icon {
            position: absolute; /* Position icon to top right */
            top: 0.8rem;
            right: 1rem;
        }
    }

    /* Hide original additional-transactions if not used by JS logic anymore */
    .additional-transactions {
        /* display: none !important; */ /* If JS still uses this, keep original styles */
        /* The new .items-list.show handles visibility */
    }

</style>
{% endblock %}

{% block content %}
<div class="container account-overview-container">
    <div class="page-header">
        <h2>Account Overview</h2>
    </div>

    <!-- Account Balance and Buttons -->
    <div class="row balance-box-wrapper align-items-center">
        <div class="col-lg-7 col-md-12"> <!-- Adjusted column for better balance display -->
            <div class="balance-box">
                <div class="balance-content">
                    <h5 class="balance-title">CURRENT BALANCE</h5>
                    <div class="balance-amount-wrapper">
                        <i class="bi bi-wallet2 balance-icon"></i>
                        <p class="balance-amount mb-0" id="balance-amount"><i class="bi bi-arrow-repeat"></i></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-5 col-md-12 mt-3 mt-lg-0"> <!-- Buttons column -->
            <div class="action-buttons-wrapper justify-content-lg-end">
                <a href="/fe/transfer" class="btn btn-primary btn-action"> <!-- Link to transfer/send money page -->
                    <i class="bi bi-send"></i> Send Money
                </a>
                <a href="/fe/deposits" class="btn btn-outline-secondary btn-action"> <!-- Link to deposits page -->
                    <i class="bi bi-plus-circle"></i> Add Funds
                </a>
            </div>
        </div>
    </div>

    <!-- Recent Transactions -->
    <div class="items-list-container">
        <div class="section-toggle" id="transactions-toggle" tabindex="0" aria-expanded="true"
             aria-controls="transactions-list-content">
            <h3>Recent Transactions</h3>
            <i class="bi bi-chevron-down"></i>
        </div>
        <div class="items-list show" id="transactions-list-content"> <!-- Initially shown -->
            <div class="list-loading-container" id="transactions-loading-alert"><i class="bi bi-arrow-repeat"></i></div>
            <div id="initial-transactions-list">
                <!-- Transaction items will be inserted here -->
            </div>
            <div id="additional-transactions-list" class="items-list-more"
                 style="max-height: 0; opacity: 0; overflow: hidden;"> <!-- For "View More" -->
                <!-- Additional transaction items will be inserted here -->
            </div>
            <div class="view-more-button-container" id="view-transactions-btn-container" style="display: none;">
                <a class="btn btn-outline-primary btn-view-more" href="#" id="view-transactions-btn">View More</a>
            </div>
        </div>
    </div>

    <!-- Recent Deposits -->
    <div class="items-list-container">
        <div class="section-toggle" id="deposits-toggle" tabindex="0" aria-expanded="true"
             aria-controls="deposits-list-content">
            <h3>Recent Deposits</h3>
            <i class="bi bi-chevron-down"></i>
        </div>
        <div class="items-list show" id="deposits-list-content"> <!-- Initially shown -->
            <div class="list-loading-container" id="deposits-loading-alert"><i class="bi bi-arrow-repeat"></i></div>
            <div id="initial-deposits-list">
                <!-- Deposit items will be inserted here -->
            </div>
            <div id="additional-deposits-list" class="items-list-more"
                 style="max-height: 0; opacity: 0; overflow: hidden;"> <!-- For "View More" -->
                <!-- Additional deposit items will be inserted here -->
            </div>
            <div class="view-more-button-container" id="view-deposits-btn-container" style="display: none;">
                <a class="btn btn-outline-primary btn-view-more" href="#" id="view-deposits-btn">View More</a>
            </div>
        </div>
    </div>

    <!-- Add padding to clear fixed footer -->
    <div style="padding-bottom: 80px;"></div>
</div>
{% endblock %}

{% block modals %}
<div aria-hidden="true" aria-labelledby="transactionModalLabel" class="modal fade" id="transactionModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered"> <!-- Centered modal -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalLabel">Transaction Details</h5>
                <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
            </div>
            <div class="modal-body">
                <p><strong>Date:</strong> <span id="modal-date"></span></p>
                <p><strong>Description:</strong> <span id="modal-description"></span></p>
                <p><strong>Amount:</strong> <span id="modal-amount"></span></p>
                <p><strong>Category:</strong> <span id="modal-category"></span></p>
                <p><strong>Status:</strong> <span id="modal-status"></span></p> <!-- Added Status -->
                <p><strong>Reference ID:</strong> <span id="modal-ref-id"></span></p> <!-- Added Ref ID -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" data-bs-dismiss="modal" type="button">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Helper to format currency consistently
    function formatCurrency(amount) {
        const absAmount = Math.abs(parseFloat(amount) || 0);
        return absAmount.toLocaleString('en-US', {style: 'currency', currency: 'USD'});
    }

    // Transaction Modal
    function attachItemEntryListeners() {
        document.querySelectorAll('.item-entry').forEach(item => {
            item.addEventListener('click', function () {
                const dataset = this.dataset;
                document.getElementById('modal-date').textContent = dataset.date || 'N/A';
                document.getElementById('modal-description').textContent = dataset.description || 'N/A';

                const amount = parseFloat(dataset.amount);
                const amountFormatted = formatCurrency(amount);
                document.getElementById('modal-amount').textContent = (amount < 0 ? '-' : '+') + amountFormatted;
                document.getElementById('modal-amount').className = amount < 0 ? 'text-danger' : 'text-success';

                document.getElementById('modal-category').textContent = dataset.category || 'N/A';
                document.getElementById('modal-status').textContent = dataset.status || 'N/A'; // For deposits or detailed transactions
                document.getElementById('modal-ref-id').textContent = dataset.transactionId || dataset.depositId || 'N/A';

                var transactionModal = new bootstrap.Modal(document.getElementById('transactionModal'));
                transactionModal.show();
            });
        });
    }

    // Generic "View More" Toggle
    function toggleMoreItems(listId, buttonId, seeAllUrl) {
        const additionalList = document.getElementById(listId);
        const viewBtn = document.getElementById(buttonId);
        const isShown = additionalList.style.maxHeight !== '0px';

        if (isShown) { // If shown, and clicked, means "See All"
            window.location.href = seeAllUrl;
        } else { // If hidden, show more
            additionalList.style.maxHeight = additionalList.scrollHeight + 'px';
            additionalList.style.opacity = '1';
            viewBtn.textContent = 'See All';
        }
    }

    // Generic function to render items
    function renderItems(items, initialListEl, additionalListEl, viewBtnContainerEl, viewBtnEl, itemType, noItemsMessage, seeAllUrl) {
        initialListEl.innerHTML = '';
        additionalListEl.innerHTML = '';

        if (!items || items.length === 0) {
            initialListEl.innerHTML = `<div class='alert alert-info mx-3'>${noItemsMessage}</div>`;
            viewBtnContainerEl.style.display = 'none';
            return;
        }

        const itemEntries = items.map(item => {
            let date, descriptionText, amountStr, amountFloat, amountClass, statusText, categoryText, refId;

            if (itemType === 'transaction') {
                date = new Date(item.date).toLocaleDateString();
                descriptionText = item.description || `Transaction ${item.id}`; // Fallback description
                statusText = item.status;
                categoryText = item.category || 'General';
                refId = item.id;
                if (item.sender_id === userData.id) { // Assuming userData.id is available
                    amountFloat = -(parseFloat(item.amount) || 0);
                    amountClass = 'negative';
                } else {
                    amountFloat = parseFloat(item.amount) || 0;
                    amountClass = 'positive';
                }
                amountStr = (amountFloat < 0 ? '-' : '+') + formatCurrency(amountFloat);
            } else { // deposit
                date = new Date(item.created_at).toLocaleDateString();
                descriptionText = `Deposit via ${item.method}`;
                statusText = item.status.charAt(0).toUpperCase() + item.status.slice(1);
                categoryText = 'Deposit';
                refId = item.id;
                amountFloat = parseFloat(item.amount) || 0;
                amountStr = '+' + formatCurrency(amountFloat);
                amountClass = 'positive';
            }

            return `
                <div class="item-entry"
                     data-transaction-id="${itemType === 'transaction' ? refId : ''}"
                     data-deposit-id="${itemType === 'deposit' ? refId : ''}"
                     data-date="${date}"
                     data-description="${descriptionText}"
                     data-amount="${amountFloat.toFixed(2)}"
                     data-category="${categoryText}"
                     data-status="${statusText}">
                    <span class="date">${date}</span>
                    <span class="description">${descriptionText}</span>
                    <span class="amount ${amountClass}">${amountStr}</span>
                    <span class="info-icon"><i class="bi bi-info-circle"></i></span>
                </div>`;
        }).join('');

        if (items.length <= 3) {
            initialListEl.innerHTML = itemEntries;
            viewBtnContainerEl.style.display = 'none';
        } else {
            initialListEl.innerHTML = items.slice(0, 3).map(item => { /* Regenerate HTML for first 3 */
                let date, descriptionText, amountStr, amountFloat, amountClass, statusText, categoryText, refId;
                if (itemType === 'transaction') {
                    date = new Date(item.date).toLocaleDateString();
                    descriptionText = item.description || `Transaction ${item.id}`;
                    statusText = item.status;
                    categoryText = item.category || 'General';
                    refId = item.id;
                    if (item.sender_id === userData.id) {
                        amountFloat = -(parseFloat(item.amount) || 0);
                        amountClass = 'negative';
                    } else {
                        amountFloat = parseFloat(item.amount) || 0;
                        amountClass = 'positive';
                    }
                    amountStr = (amountFloat < 0 ? '-' : '+') + formatCurrency(amountFloat);
                } else {
                    date = new Date(item.created_at).toLocaleDateString();
                    descriptionText = `Deposit via ${item.method}`;
                    statusText = item.status.charAt(0).toUpperCase() + item.status.slice(1);
                    categoryText = 'Deposit';
                    refId = item.id;
                    amountFloat = parseFloat(item.amount) || 0;
                    amountStr = '+' + formatCurrency(amountFloat);
                    amountClass = 'positive';
                }
                return `
                <div class="item-entry"
                     data-transaction-id="${itemType === 'transaction' ? refId : ''}" data-deposit-id="${itemType === 'deposit' ? refId : ''}"
                     data-date="${date}" data-description="${descriptionText}" data-amount="${amountFloat.toFixed(2)}" data-category="${categoryText}" data-status="${statusText}">
                    <span class="date">${date}</span> <span class="description">${descriptionText}</span> <span class="amount ${amountClass}">${amountStr}</span> <span class="info-icon"><i class="bi bi-info-circle"></i></span>
                </div>`;
            }).join('');

            additionalListEl.innerHTML = items.slice(3).map(item => { /* Regenerate HTML for rest */
                let date, descriptionText, amountStr, amountFloat, amountClass, statusText, categoryText, refId;
                if (itemType === 'transaction') {
                    date = new Date(item.date).toLocaleDateString();
                    descriptionText = item.description || `Transaction ${item.id}`;
                    statusText = item.status;
                    categoryText = item.category || 'General';
                    refId = item.id;
                    if (item.sender_id === userData.id) {
                        amountFloat = -(parseFloat(item.amount) || 0);
                        amountClass = 'negative';
                    } else {
                        amountFloat = parseFloat(item.amount) || 0;
                        amountClass = 'positive';
                    }
                    amountStr = (amountFloat < 0 ? '-' : '+') + formatCurrency(amountFloat);
                } else {
                    date = new Date(item.created_at).toLocaleDateString();
                    descriptionText = `Deposit via ${item.method}`;
                    statusText = item.status.charAt(0).toUpperCase() + item.status.slice(1);
                    categoryText = 'Deposit';
                    refId = item.id;
                    amountFloat = parseFloat(item.amount) || 0;
                    amountStr = '+' + formatCurrency(amountFloat);
                    amountClass = 'positive';
                }
                return `
                <div class="item-entry"
                     data-transaction-id="${itemType === 'transaction' ? refId : ''}" data-deposit-id="${itemType === 'deposit' ? refId : ''}"
                     data-date="${date}" data-description="${descriptionText}" data-amount="${amountFloat.toFixed(2)}" data-category="${categoryText}" data-status="${statusText}">
                    <span class="date">${date}</span> <span class="description">${descriptionText}</span> <span class="amount ${amountClass}">${amountStr}</span> <span class="info-icon"><i class="bi bi-info-circle"></i></span>
                </div>`;
            }).join('');

            additionalListEl.style.maxHeight = '0px'; // Ensure it's collapsed initially
            additionalListEl.style.opacity = '0';
            viewBtnEl.textContent = 'View More';
            viewBtnContainerEl.style.display = 'block';

            // Remove old listener before adding new one to prevent multiple bindings
            const newViewBtnEl = viewBtnEl.cloneNode(true);
            viewBtnEl.parentNode.replaceChild(newViewBtnEl, viewBtnEl);

            newViewBtnEl.addEventListener('click', function (e) {
                e.preventDefault();
                toggleMoreItems(additionalListEl.id, newViewBtnEl.id, seeAllUrl);
            });
        }
        attachItemEntryListeners();
    }


    async function fetchTransactions() {
        const loadingAlert = document.getElementById('transactions-loading-alert');
        try {
            loadingAlert.classList.remove('hidden');
            const response = await fetch(`${API_BASE}/transactions`, {
                method: 'GET',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`}
            });
            if (!response.ok) throw new Error(`Failed to fetch transactions: ${response.status}`);

            const data = await response.json();
            const transactions = data.transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            renderItems(
                transactions.slice(0, 12), // Show up to 12, JS handles 3 + more
                document.getElementById('initial-transactions-list'),
                document.getElementById('additional-transactions-list'),
                document.getElementById('view-transactions-btn-container'),
                document.getElementById('view-transactions-btn'),
                'transaction',
                'No transactions yet.',
                '/fe/transactions' // URL for "See All"
            );
        } catch (error) {
            console.error('Error fetching transactions:', error);
            document.getElementById('initial-transactions-list').innerHTML = "<div class='alert alert-danger mx-3'>Could not load transactions.</div>";
        } finally {
            loadingAlert.classList.add('hidden');
        }
    }

    async function fetchDeposits() {
        const loadingAlert = document.getElementById('deposits-loading-alert');
        try {
            loadingAlert.classList.remove('hidden');
            const response = await fetch(`${API_BASE}/deposits`, {
                method: 'GET',
                headers: {'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`}
            });
            if (!response.ok) throw new Error(`Failed to fetch deposits: ${response.status}`);

            const data = await response.json();
            const deposits = data.deposits.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            renderItems(
                deposits.slice(0, 12), // Show up to 12
                document.getElementById('initial-deposits-list'),
                document.getElementById('additional-deposits-list'),
                document.getElementById('view-deposits-btn-container'),
                document.getElementById('view-deposits-btn'),
                'deposit',
                'No deposits yet.',
                '/fe/all-deposits' // URL for "See All"
            );
        } catch (error) {
            console.error('Error fetching deposits:', error);
            document.getElementById('initial-deposits-list').innerHTML = "<div class='alert alert-danger mx-3'>Could not load deposits.</div>";
        } finally {
            loadingAlert.classList.add('hidden');
        }
    }

    // Generic Toggle Function for Sections
    function setupSectionToggle(toggleId, listId) {
        const toggleElement = document.getElementById(toggleId);
        const listElement = document.getElementById(listId);
        const arrowIcon = toggleElement.querySelector('i.bi-chevron-down');

        // Initialize based on 'show' class (which means expanded)
        const isInitiallyShown = listElement.classList.contains('show');
        toggleElement.setAttribute('aria-expanded', isInitiallyShown.toString());
        if (!isInitiallyShown) { // If not shown, ensure it's collapsed and arrow is up
            listElement.style.maxHeight = '0px';
            listElement.style.opacity = '0';
            arrowIcon.classList.remove('up'); // Ensure arrow points down if collapsed
        } else {
            arrowIcon.classList.add('up'); // Ensure arrow points up if expanded
            listElement.style.maxHeight = listElement.scrollHeight + 'px'; // Set initial max-height if shown
        }


        toggleElement.addEventListener('click', () => {
            const isCurrentlyShown = listElement.classList.toggle('show');
            toggleElement.setAttribute('aria-expanded', isCurrentlyShown.toString());
            arrowIcon.classList.toggle('up', isCurrentlyShown);

            if (isCurrentlyShown) {
                listElement.style.maxHeight = listElement.scrollHeight + 'px';
                listElement.style.opacity = '1';
                // After transition, set to auto or large value if content might change
                setTimeout(() => {
                    if (listElement.classList.contains('show')) listElement.style.maxHeight = '2500px';
                }, 500); // Match CSS transition
            } else {
                // Temporarily set max-height to current scroll height to animate from there
                listElement.style.maxHeight = listElement.scrollHeight + 'px';
                // Force reflow
                listElement.offsetHeight;
                listElement.style.maxHeight = '0px';
                listElement.style.opacity = '0';
            }
        });

        // Keyboard accessibility
        toggleElement.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggleElement.click();
            }
        });

        // Observe changes in list content to readjust max-height if shown
        const observer = new MutationObserver(() => {
            if (listElement.classList.contains('show')) {
                listElement.style.maxHeight = listElement.scrollHeight + 'px';
                setTimeout(() => { // Reset to allow further expansion if needed
                    if (listElement.classList.contains('show')) listElement.style.maxHeight = '2500px';
                }, 500);
            }
        });
        observer.observe(listElement, {childList: true, subtree: true});
    }


    document.addEventListener("DOMContentLoaded", async function () {
        try {
            const balanceAmountEl = document.getElementById('balance-amount');
            if (userData && userData.balance !== undefined) { // Check if userData and balance are already populated
                balanceAmountEl.innerHTML = formatCurrency(userData.balance);
            } else {
                await refreshUserData(); // refreshUserData should populate global `userData`
                balanceAmountEl.innerHTML = userData.balance ? formatCurrency(userData.balance) : '$ 0.00';
            }

            if (userData && userData.id) {
                await Promise.all([fetchTransactions(), fetchDeposits()]);
            } else { // Fallback if userData wasn't populated by base.html's initial call
                await refreshUserData();
                if (userData && userData.id) {
                    await Promise.all([fetchTransactions(), fetchDeposits()]);
                } else {
                    console.error("User data not available after refresh for overview page.");
                    // Display error messages in lists
                    document.getElementById('initial-transactions-list').innerHTML = "<div class='alert alert-danger mx-3'>Could not load user data for transactions.</div>";
                    document.getElementById('initial-deposits-list').innerHTML = "<div class='alert alert-danger mx-3'>Could not load user data for deposits.</div>";
                }
            }

            setupSectionToggle('transactions-toggle', 'transactions-list-content');
            setupSectionToggle('deposits-toggle', 'deposits-list-content');

            document.dispatchEvent(new CustomEvent('pageContentLoaded'));

        } catch (error) {
            console.error('Error loading page content:', error);
            document.getElementById('balance-amount').innerHTML = `<span class="text-danger" style="font-size: 1rem;">Error</span>`;
            document.dispatchEvent(new CustomEvent('pageContentLoaded')); // Still dispatch so loading screen hides
        }
    });
</script>
{% endblock %}