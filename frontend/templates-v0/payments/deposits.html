{% extends "base.html" %}

{% block styles %}
<style type="text/css">
    /* Main Content Alignment */
    .main-content { /* Styles inherited from base.html, ensure padding is appropriate */
        /* padding-top: 2rem; /* Adjust if needed, base.html has 2rem */
    }

    .deposit-page-container {
        max-width: 800px; /* Max width for the content on this page */
        margin: 0 auto; /* Center the content */
        padding: 0 1rem; /* Padding for smaller screens */
    }

    /* Deposit Title */
    .deposit-title-main { /* More specific class */
        font-size: 2.25rem;
        font-weight: 700;
        margin-bottom: 2.5rem;
        text-align: center;
        color: var(--accent-color);
        font-family: 'Inter', sans-serif; /* Consistent font */
    }

    /* Deposit Box Styles - Enhanced */
    .deposit-form-box { /* Renamed for clarity */
        position: relative;
        width: 100%;
        padding: 2rem 2.5rem; /* Adjusted padding */
        background: var(--background-color); /* Use page background or a subtle card background */
        border: 1px solid var(--bs-border-color); /* Theme border */
        border-radius: 1rem; /* Consistent rounding */
        box-shadow: var(--transaction-shadow); /* Use theme shadow */
        transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out, padding 0.5s ease-in-out, margin-bottom 0.5s ease-in-out;
        font-family: 'Inter', sans-serif;
        font-size: 1rem; /* Base font size for form */
        overflow: hidden;
        max-height: 1200px; /* Increased default max-height */
        margin-bottom: 2.5rem;
    }
    [data-bs-theme="dark"] .deposit-form-box {
        background: var(--bs-tertiary-bg); /* Slightly different from page bg in dark mode */
    }


    .deposit-form-box.hidden {
        max-height: 0 !important;
        opacity: 0 !important;
        padding-top: 0;
        padding-bottom: 0;
        margin-bottom: 0 !important;
        border-width: 0; /* Hide border when collapsed */
    }

    /* Form Elements - Enhanced */
    .form-group {
        margin-bottom: 1.75rem; /* Adjusted spacing */
        /* padding: 0; /* Removed extra padding here, handled by deposit-form-box */
    }

    .form-group label {
        display: block;
        margin-bottom: 0.6rem; /* Reduced space */
        font-weight: 500;
        color: var(--text-color);
        font-size: 0.95rem; /* Slightly smaller label */
    }

    .form-control, .stripe-element { /* Common styling for form inputs and Stripe element */
        background-color: var(--bs-body-bg); /* Use Bootstrap's body background for inputs */
        border: 1px solid var(--bs-border-color); /* Theme border */
        border-radius: 0.5rem; /* Standardized rounding */
        padding: 0.875rem 1rem; /* Adjusted padding */
        font-size: 1rem; /* Standardized font size */
        color: var(--text-color); /* Theme text color */
        width: 100%;
        box-sizing: border-box;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        font-family: 'Inter', sans-serif;
    }
    [data-bs-theme="dark"] .form-control {
        background-color: var(--bs-tertiary-bg); /* Darker input background */
    }


    .form-control:focus, .stripe-element--focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.2rem rgba(var(--accent-color-rgb), 0.25); /* Bootstrap-like focus */
        outline: none;
    }

    /* Stripe Elements Specifics */
    .stripe-element {
        /* padding adjusted in common style */
    }
    .stripe-element.StripeElement--invalid {
        border-color: var(--bs-danger); /* Use Bootstrap danger color */
    }
    #card-element { /* Ensure Stripe element has enough height */
        min-height: calc(1.5em + 1.75rem + 2px); /* Match Bootstrap input height */
        display: flex;
        align-items: center;
    }


    /* Input Groups - Enhanced */
    .amount-input-group, .saved-cards-input-group { /* Renamed for clarity */
        display: flex;
        align-items: stretch; /* Ensure items stretch to full height */
        height: calc(1.5em + 1.75rem + 2px); /* Match Bootstrap input height */
    }

    .input-group-text-custom { /* Replaces .currency-display and .saved-cards-icon */
        background-color: var(--bs-secondary-bg); /* Subtle background */
        color: var(--text-color);
        border: 1px solid var(--bs-border-color);
        padding: 0.875rem 1rem;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-right: none;
        border-radius: 0.5rem 0 0 0.5rem;
    }
    .input-group-text-custom i.bi { /* Icon within the text part */
        font-size: 1.25rem;
    }

    .amount-input-group .form-control, .saved-cards-input-group .form-control {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        /* border-left: none; /* This can cause a slight visual disconnect, let border be there */
        flex-grow: 1;
        height: 100%; /* Ensure it fills the group height */
    }

    .saved-cards-input-group {
        position: relative; /* For dropdown arrow */
    }
    .saved-cards-input-group .form-control { /* Select specific */
        padding-right: 2.5rem; /* Space for arrow */
        appearance: none; /* Remove default select arrow */
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
    }
    [data-bs-theme="dark"] .saved-cards-input-group .form-control {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23adb5bd' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    }


    /* Confirm Button - Enhanced */
    .btn-confirm-deposit { /* Renamed for specificity */
        background-color: var(--accent-color);
        border-color: var(--accent-color);
        color: var(--sidebar-text-color); /* Assuming light text on accent */
        padding: 0.875rem 1.5rem;
        font-size: 1.1rem; /* Adjusted size */
        font-weight: 600;
        border-radius: 0.5rem;
        width: 100%;
        margin-top: 1rem; /* Space above button */
        transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-confirm-deposit:hover:not(:disabled) {
        background-color: var(--accent-color-hover);
        border-color: var(--accent-color-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(var(--accent-color-rgb), 0.25);
    }
    .btn-confirm-deposit:disabled {
        opacity: 0.65; /* Bootstrap default */
        cursor: not-allowed;
    }
    [data-bs-theme="dark"] .btn-confirm-deposit {
        color: var(--text-color); /* Or specific dark theme button text color */
    }


    /* Save Card Checkbox - Enhanced */
    .save-card-option { /* Renamed for clarity */
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1rem;
        font-size: 0.95rem;
        color: var(--text-color);
    }
    .save-card-option input[type="checkbox"] {
        width: 1.1rem;
        height: 1.1rem;
        accent-color: var(--accent-color); /* Modern way to color checkboxes */
        border: 1px solid var(--bs-border-color);
        border-radius: 0.25rem;
        flex-shrink: 0;
    }
    .save-card-option label {
        margin: 0;
        font-weight: 400; /* Normal weight */
    }

    /* Message Styles - Enhanced */
    .form-message { /* Common class for success/error messages */
        max-height: 0;
        opacity: 0;
        padding: 0 1rem; /* Horizontal padding when visible */
        margin: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease-out, margin-top 0.3s ease-out;
        border-radius: 0.5rem;
        font-size: 0.95rem;
    }
    .form-message.visible {
        margin-top: 1rem; /* Space above message */
        max-height: 100px; /* Adjust as needed */
        opacity: 1;
        padding: 0.75rem 1rem; /* Vertical padding when visible */
    }
    .form-message.alert-success { /* Bootstrap success colors */
        color: var(--bs-success-text-emphasis);
        background-color: var(--bs-success-bg-subtle);
        border: 1px solid var(--bs-success-border-subtle);
    }
    .form-message.alert-danger { /* Bootstrap danger colors */
        color: var(--bs-danger-text-emphasis);
        background-color: var(--bs-danger-bg-subtle);
        border: 1px solid var(--bs-danger-border-subtle);
    }
    .card-error-message-stripe { /* Specific for Stripe card errors */
        color: var(--bs-danger);
        font-size: 0.875rem;
        margin-top: 0.5rem;
    }

    /* Header Toggle for Recent Deposits - Use .section-toggle from overview.html if identical */
    .section-toggle-deposits { /* If specific styling needed */
        /* ... similar to .section-toggle in overview.html ... */
        /* For now, assume .section-toggle from base or overview is sufficient or copy if needed */
        color: var(--text-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        width: 100%;
        padding: 1rem 1.5rem;
        background: var(--balance-bg);
        border-radius: 0.75rem;
        font-family: 'Inter', sans-serif;
        margin-bottom: 1rem;
        box-shadow: 0 2px 5px rgba(var(--accent-color-rgb), 0.08);
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
        margin-top: 2.5rem; /* Space above this section */
    }
    .section-toggle-deposits:hover {
        background-color: rgba(var(--accent-color-rgb), 0.05);
        box-shadow: 0 4px 8px rgba(var(--accent-color-rgb), 0.12);
    }
    .section-toggle-deposits h3 {
        margin: 0; font-size: 1.25rem; font-weight: 600; color: var(--text-color);
    }
    .section-toggle-deposits i.bi-chevron-down {
        font-size: 1.25rem; color: var(--accent-color); transition: transform 0.3s ease;
    }
    .section-toggle-deposits i.bi-chevron-down.up { transform: rotate(180deg); }


    /* Recent Deposits List - Use .items-list from overview.html if identical */
    .recent-deposits-list {
        /* ... similar to .items-list in overview.html ... */
        background-color: var(--background-color);
        border-radius: 0.75rem;
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out, padding-top 0.5s ease-in-out, padding-bottom 0.5s ease-in-out;
        padding-top: 0;
        padding-bottom: 0;
    }
    .recent-deposits-list.show {
        max-height: 2500px; opacity: 1; padding-top: 1rem; padding-bottom: 1rem;
    }
    /* Deposit Item - Use .item-entry from overview.html if identical */
    .deposit-list-item { /* If specific styling needed */
        /* ... similar to .item-entry in overview.html ... */
        display: flex; justify-content: space-between; align-items: center;
        padding: 1rem 1.5rem; border-bottom: 1px solid var(--bs-border-color);
        transition: background-color 0.2s ease; cursor: pointer; font-family: 'Inter', sans-serif;
    }
    .deposit-list-item:last-child { border-bottom: none; }
    .deposit-list-item:hover { background-color: rgba(var(--accent-color-rgb), 0.03); }
    .deposit-list-item .date, .deposit-list-item .card-details, .deposit-list-item .status {
        font-size: 0.95rem; color: var(--text-color); opacity: 0.9; flex-basis: 30%;
    }
    .deposit-list-item .card-details { flex-grow: 1; }
    .deposit-list-item .amount {
        font-size: 1rem; font-weight: 600; color: var(--bs-success);
        min-width: 100px; text-align: right; flex-basis: 20%;
    }
    .deposit-list-item .info-icon {
        font-size: 1.1rem; color: var(--accent-color); opacity: 0.7;
        transition: opacity 0.2s ease; flex-basis: 10%; text-align: right;
    }
    .deposit-list-item:hover .info-icon { opacity: 1; }


    /* Manage Cards Button in Form */
    .label-button-container {
        display: flex;
        justify-content: space-between;
        align-items: center; /* Align label and button */
        margin-bottom: 0.6rem; /* Match label margin */
    }
    .btn-manage-cards { /* Renamed for specificity */
        background-color: transparent;
        color: var(--accent-color);
        border: 1px solid var(--accent-color);
        border-radius: 0.375rem; /* Smaller radius for smaller button */
        padding: 0.3rem 0.8rem;
        font-size: 0.85rem;
        font-weight: 500;
        font-family: 'Inter', sans-serif;
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
    }
    .btn-manage-cards:hover {
        background-color: rgba(var(--accent-color-rgb), 0.1);
        transform: translateY(-1px);
    }
    .btn-manage-cards i.bi {
        margin-right: 0.3rem;
    }

    /* Stripe Error Box */
    .stripe-critical-error-box { /* Renamed */
        /* Similar to .deposit-form-box but for critical errors */
        padding: 2rem;
        text-align: center;
        border: 1px solid var(--bs-danger-border-subtle);
        background-color: var(--bs-danger-bg-subtle);
        color: var(--bs-danger-text-emphasis);
    }
    .stripe-critical-error-box img {
        max-width: 150px; /* Smaller error image */
        margin-bottom: 1rem;
    }
    .stripe-critical-error-box .btn-refresh-page { /* Renamed */
        /* Use .btn-confirm-deposit styles or a new one */
        margin-top: 1rem;
    }


    /* Modal Styles - Enhanced */
    /* Manage Cards Modal */
    .modal-manage-cards .modal-content, .modal-deposit-details .modal-content {
        font-family: 'Inter', sans-serif;
        background: var(--background-color);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.75rem;
    }
    .modal-manage-cards .modal-header, .modal-deposit-details .modal-header {
        border-bottom: 1px solid var(--bs-border-color); padding: 1rem 1.5rem;
    }
    .modal-manage-cards .modal-title, .modal-deposit-details .modal-title {
        font-size: 1.25rem; font-weight: 600; color: var(--text-color);
    }
    .modal-manage-cards .modal-body, .modal-deposit-details .modal-body { padding: 1.5rem; }
    .modal-manage-cards .modal-footer, .modal-deposit-details .modal-footer {
        border-top: 1px solid var(--bs-border-color); padding: 1rem 1.5rem;
    }

    .saved-card-entry { /* Replaces .saved-cards-list-item */
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.875rem 1rem;
        margin-bottom: 0.5rem;
        background: var(--bs-secondary-bg); /* Subtle background for items */
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        font-size: 0.95rem;
        color: var(--text-color);
        transition: background-color 0.2s ease;
    }
    .saved-card-entry:hover {
        background-color: var(--bs-tertiary-bg);
    }
    .saved-card-entry .card-info { display: flex; align-items: center; gap: 0.75rem; flex-grow: 1; }
    .saved-card-entry .card-icon { font-size: 1.25rem; color: var(--accent-color); }
    .saved-card-entry .card-actions { display: flex; align-items: center; gap: 0.5rem; }
    .saved-card-entry .default-badge {
        background-color: var(--accent-color); color: white;
        padding: 0.25rem 0.6rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 500;
    }
    .btn-remove-card { /* Renamed */
        background: transparent; border: none; color: var(--bs-danger); padding: 0.25rem;
        opacity: 0.7; transition: opacity 0.2s ease;
    }
    .btn-remove-card:hover { opacity: 1; }
    .btn-remove-card i.bi { font-size: 1.1rem; vertical-align: middle; }

    /* Deposit Details Modal */
    .modal-deposit-details .modal-body p { font-size: 1rem; margin-bottom: 0.75rem; }
    .modal-deposit-details .modal-body p strong { font-weight: 600; color: var(--accent-color); }


    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .deposit-page-container { padding: 0 0.75rem; }
        .deposit-title-main { font-size: 1.8rem; margin-bottom: 1.5rem; }
        .deposit-form-box { padding: 1.5rem; font-size: 0.95rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-control, .stripe-element, .input-group-text-custom { font-size: 0.95rem; padding: 0.75rem; }
        #card-element { min-height: calc(1.5em + 1.5rem + 2px); }
        .amount-input-group, .saved-cards-input-group { height: calc(1.5em + 1.5rem + 2px); }
        .btn-confirm-deposit { font-size: 1rem; padding: 0.75rem 1.25rem; }
        .save-card-option { font-size: 0.9rem; }
        .section-toggle-deposits h3 { font-size: 1.1rem; }
        .deposit-list-item { font-size: 0.9rem; padding: 0.75rem 1rem; }
    }

</style>
{% endblock %}

{% block content %}
<div class="deposit-page-container">
    <h2 class="deposit-title-main">Make a Deposit</h2>

    <!-- Deposit Box with Stripe Integration -->
    <div class="deposit-form-box" id="stripe-deposit-box">
        <div class="form-message alert alert-success" id="success-message-deposit" role="alert" style="display: none;"></div>
        <div class="form-message alert alert-danger" id="error-message-deposit" role="alert" style="display: none;"></div>

        <form id="deposit-form-main" method="POST">
            <!-- Amount Input -->
            <div class="form-group">
                <label for="deposit-amount">Amount</label>
                <div class="amount-input-group">
                    <span class="input-group-text-custom">USD</span>
                    <input class="form-control" id="deposit-amount" max="10000" min="0.50" name="amount"
                           placeholder="Enter amount" required step="0.01" type="number">
                </div>
                <div class="form-message alert-danger" id="amount-error-message" style="display: none;"></div>
            </div>

            <!-- Saved Payment Methods -->
            <div class="form-group" id="saved-payment-method-group">
                <div class="label-button-container">
                    <label for="select-payment-method">Payment Method</label>
                    <button class="btn-manage-cards" id="open-manage-cards-modal" type="button">
                        <i class="bi bi-gear"></i> Manage Cards
                    </button>
                </div>
                <div class="saved-cards-input-group">
                    <span class="input-group-text-custom"><i class="bi bi-credit-card" id="selected-card-brand-icon"></i></span>
                    <select class="form-control" id="select-payment-method">
                        <!-- Options populated by JS -->
                    </select>
                </div>
            </div>

            <!-- Card Element (shown only for new card) -->
            <div class="form-group" id="stripe-card-element-group" style="display: none;"> <!-- Initially hidden -->
                <label for="stripe-card-element">Card Information</label>
                <div class="stripe-element" id="stripe-card-element"></div> <!-- Stripe element mounts here -->
                <div class="card-error-message-stripe" id="stripe-card-error-message" style="display: none;"></div>
            </div>

            <div class="save-card-option" id="save-new-card-option" style="display: none;"> <!-- Initially hidden -->
                <input id="checkbox-save-card" name="save-card" type="checkbox">
                <label for="checkbox-save-card">Save this card for future deposits</label>
            </div>

            <!-- Submit Button -->
            <button class="btn btn-confirm-deposit mt-4" id="btn-submit-deposit" type="submit">
                <span id="btn-deposit-text">Confirm Deposit</span>
                <span id="deposit-spinner" style="display: none;"><i class="bi bi-arrow-repeat"></i> Processing...</span>
            </button>
        </form>
    </div>

    <!-- Stripe Critical Error Box -->
    <div class="stripe-critical-error-box" id="stripe-critical-error-display" style="display: none;">
        <img alt="Error Illustration" src="https://via.placeholder.com/150/FF0000/FFFFFF?Text=Error" /> <!-- Placeholder, replace with actual error image if desired -->
        <div class="form-message alert alert-danger visible" id="critical-error-text-stripe"></div>
        <button class="btn btn-confirm-deposit btn-refresh-page" id="btn-refresh-on-error" type="button">
            Refresh Page
        </button>
    </div>

    <!-- Recent Deposits Section -->
    <div class="section-toggle-deposits" id="toggle-recent-deposits" tabindex="0" aria-expanded="false" aria-controls="recent-deposits-list-content">
        <h3>Recent Deposits</h3>
        <i class="bi bi-chevron-down"></i>
    </div>
    <div class="recent-deposits-list" id="recent-deposits-list-content">
        <div class="list-loading-container" id="recent-deposits-loading"><i class="bi bi-arrow-repeat"></i></div>
        <div id="initial-recent-deposits">
            <!-- Deposit items will be inserted here by JS -->
        </div>
        <div id="additional-recent-deposits" class="items-list-more" style="max-height: 0; opacity: 0; overflow: hidden;">
            <!-- Additional deposit items -->
        </div>
        <div class="view-more-button-container" id="view-more-deposits-btn-container" style="display: none;">
            <a class="btn btn-outline-primary btn-view-more" href="#" id="btn-view-more-deposits">View More</a>
        </div>
    </div>
     <!-- Add padding to clear fixed footer -->
    <div style="padding-bottom: 80px;"></div>
</div>
{% endblock %}

{% block modals %}
<!-- Modal for Managing Saved Cards -->
<div class="modal fade modal-manage-cards" id="manageCardsModal" tabindex="-1" aria-labelledby="manageCardsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg"> <!-- Larger modal -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manageCardsModalLabel">Manage Saved Cards</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-message alert alert-danger" id="manage-cards-modal-error" style="display: none;"></div>
                <div class="form-message alert alert-success" id="manage-cards-modal-success" style="display: none;"></div>
                <div id="modal-saved-cards-list-container">
                    <!-- Saved cards list populated by JS -->
                    <p id="no-saved-cards-message" style="display:none;">You have no saved cards.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Deposit Details Modal -->
<div class="modal fade modal-deposit-details" id="depositDetailsModal" tabindex="-1" aria-labelledby="depositDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="depositDetailsModalLabel">Deposit Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Date:</strong> <span id="detail-modal-date"></span></p>
                <p><strong>Card:</strong> <span id="detail-modal-card"></span></p>
                <p><strong>Amount:</strong> <span id="detail-modal-amount"></span></p>
                <p><strong>Status:</strong> <span id="detail-modal-status"></span></p>
                <p><strong>Reference ID:</strong> <span id="detail-modal-ref-id"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://js.stripe.com/v3/"></script>
<!-- jQuery might not be strictly needed if Bootstrap 5 JS is used without it, but keeping if base.html relies on it -->
<!-- <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> -->

<script>
    let stripeInstance;
    let stripeElements;
    let stripeCardElement;
    let currentSavedCards = []; // To store fetched saved cards

    const brandIconClasses = {
        visa: 'bi bi-credit-card-2-front-fill',
        mastercard: 'bi bi-credit-card-fill', // Using a generic fill for MC
        amex: 'bi bi-credit-card-fill', // AMEX often uses a filled icon
        discover: 'bi bi-credit-card',
        diners: 'bi bi-credit-card',
        jcb: 'bi bi-credit-card',
        unionpay: 'bi bi-credit-card',
        unknown: 'bi bi-credit-card',
        default: 'bi bi-credit-card'
    };
    function getCardBrandIcon(brand) {
        return brandIconClasses[brand?.toLowerCase()] || brandIconClasses.default;
    }

    // --- UI Helper Functions ---
    function setLoadingState(isLoading) {
        const submitButton = document.getElementById('btn-submit-deposit');
        const buttonText = document.getElementById('btn-deposit-text');
        const spinner = document.getElementById('deposit-spinner');
        const formBox = document.getElementById('stripe-deposit-box');

        if (submitButton && buttonText && spinner && formBox) {
            submitButton.disabled = isLoading;
            buttonText.style.display = isLoading ? 'none' : 'inline';
            spinner.style.display = isLoading ? 'inline-block' : 'none'; // Use inline-block for spinner icon
            formBox.classList.toggle('form-loading', isLoading); // Optional: class to dim form
        }
    }

    function displayFormMessage(message, type = 'error', containerId = 'stripe-deposit-box') {
        const messageId = type === 'success' ? 'success-message-deposit' : 'error-message-deposit';
        const messageDiv = document.getElementById(messageId);
        const otherMessageId = type === 'success' ? 'error-message-deposit' : 'success-message-deposit';
        const otherMessageDiv = document.getElementById(otherMessageId);

        if (otherMessageDiv) {
            otherMessageDiv.classList.remove('visible');
            otherMessageDiv.style.display = 'none';
        }
        if (messageDiv) {
            messageDiv.textContent = message;
            messageDiv.className = `form-message alert alert-${type === 'success' ? 'success' : 'danger'} visible`;
            messageDiv.style.display = 'block';
            messageDiv.setAttribute('role', 'alert');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.classList.remove('visible');
                messageDiv.style.display = 'none';
            }, 5000);
        }
    }

    function displayModalMessage(message, type = 'error', modalId = 'manageCardsModal') {
        const messageId = type === 'success' ? 'manage-cards-modal-success' : 'manage-cards-modal-error';
        const messageDiv = document.getElementById(messageId);
        const otherMessageId = type === 'success' ? 'manage-cards-modal-error' : 'manage-cards-modal-success';
        const otherMessageDiv = document.getElementById(otherMessageId);

        if (otherMessageDiv) otherMessageDiv.style.display = 'none';
        if (messageDiv) {
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
             setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
        }
    }

    function displayStripeCriticalError(message, showRefresh = true) {
        document.getElementById('stripe-deposit-box').style.display = 'none';
        document.getElementById('toggle-recent-deposits').style.display = 'none';
        document.getElementById('recent-deposits-list-content').style.display = 'none';

        const errorBox = document.getElementById('stripe-critical-error-display');
        const errorTextDiv = document.getElementById('critical-error-text-stripe');
        const refreshButton = document.getElementById('btn-refresh-on-error');

        if (errorBox && errorTextDiv && refreshButton) {
            errorTextDiv.textContent = message;
            errorBox.style.display = 'block';
            refreshButton.style.display = showRefresh ? 'block' : 'none';
        }
    }

    // --- Stripe and Card Functions ---
    async function initializeStripeElements() {
        if (!token) {
            displayStripeCriticalError('Authentication required. Please log in.', false);
            setTimeout(() => window.location.href = `${FE_BASE}/login`, 3000);
            return;
        }
        try {
            const configResponse = await fetch(`${API_BASE}/cards/config`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!configResponse.ok) throw new Error('Failed to fetch Stripe configuration.');

            const { publishable_key } = await configResponse.json();
            stripeInstance = Stripe(publishable_key);
            stripeElements = stripeInstance.elements();

            const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
            const style = {
                base: {
                    color: isDark ? '#e0e0e0' : '#212529', // Match theme text
                    fontFamily: '"Inter", sans-serif',
                    fontSize: '16px', // Bootstrap base font size
                    '::placeholder': { color: isDark ? '#6c757d' : '#adb5bd' },
                },
                invalid: { color: '#dc3545', iconColor: '#dc3545' },
            };
            stripeCardElement = stripeElements.create('card', { style });
            stripeCardElement.mount('#stripe-card-element');

            stripeCardElement.on('change', event => {
                const displayError = document.getElementById('stripe-card-error-message');
                displayError.textContent = event.error ? event.error.message : '';
                displayError.style.display = event.error ? 'block' : 'none';
            });
        } catch (error) {
            console.error('Stripe Initialization Error:', error);
            displayStripeCriticalError('Could not initialize payment system. Please try again later.');
        }
    }

    async function loadSavedCards() {
        if (!token) return;
        try {
            const response = await fetch(`${API_BASE}/cards`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Failed to fetch saved cards.');

            const data = await response.json();
            currentSavedCards = data.cards || [];
            populatePaymentMethodsDropdown(currentSavedCards);
            populateManageCardsModal(currentSavedCards);
        } catch (error) {
            console.error('Error loading saved cards:', error);
            displayFormMessage('Could not load saved payment methods.', 'error');
            populatePaymentMethodsDropdown([]); // Show 'new card' only
        }
    }

    function populatePaymentMethodsDropdown(cards) {
        const selectEl = document.getElementById('select-payment-method');
        const cardIconEl = document.getElementById('selected-card-brand-icon');
        const newCardGroup = document.getElementById('stripe-card-element-group');
        const saveCardOption = document.getElementById('save-new-card-option');

        selectEl.innerHTML = '<option value="new">Use a new card</option>'; // Default option

        let defaultSelected = 'new';
        cards.forEach(card => {
            const option = document.createElement('option');
            option.value = card.stripe_payment_method_id;
            option.textContent = `${card.brand ? card.brand.charAt(0).toUpperCase() + card.brand.slice(1) : 'Card'} **** ${card.last_four} (Exp: ${card.exp_month}/${String(card.exp_year).slice(2)})`;
            option.dataset.brand = card.brand;
            selectEl.appendChild(option);
            if (card.is_default) defaultSelected = card.stripe_payment_method_id;
        });

        selectEl.value = defaultSelected; // Select default or 'new'

        function updateFormForSelection() {
            const selectedValue = selectEl.value;
            const selectedOption = selectEl.querySelector(`option[value="${selectedValue}"]`);
            const brand = selectedOption ? selectedOption.dataset.brand : 'default';

            cardIconEl.className = getCardBrandIcon(brand);
            if (selectedValue === 'new') {
                newCardGroup.style.display = 'block';
                saveCardOption.style.display = 'flex'; // Show save card option
                if(stripeCardElement) stripeCardElement.focus();
            } else {
                newCardGroup.style.display = 'none';
                saveCardOption.style.display = 'none'; // Hide save card for existing
            }
        }
        selectEl.addEventListener('change', updateFormForSelection);
        updateFormForSelection(); // Initial call
    }

    // --- Manage Cards Modal ---
    function populateManageCardsModal(cards) {
        const listContainer = document.getElementById('modal-saved-cards-list-container');
        const noCardsMsg = document.getElementById('no-saved-cards-message');
        listContainer.innerHTML = ''; // Clear previous items

        if (cards.length === 0) {
            if(noCardsMsg) noCardsMsg.style.display = 'block';
            return;
        }
        if(noCardsMsg) noCardsMsg.style.display = 'none';

        cards.forEach(card => {
            const item = document.createElement('div');
            item.className = 'saved-card-entry';
            item.innerHTML = `
                <div class="card-info">
                    <i class="${getCardBrandIcon(card.brand)} card-icon"></i>
                    <span>${card.brand ? card.brand.charAt(0).toUpperCase() + card.brand.slice(1) : 'Card'} **** ${card.last_four} (Exp: ${card.exp_month}/${String(card.exp_year).slice(2)})</span>
                </div>
                <div class="card-actions">
                    ${card.is_default ? '<span class="default-badge">Default</span>' : `<button type="button" class="btn btn-sm btn-outline-secondary btn-set-default" data-card-id="${card.id}">Set Default</button>`}
                    <button type="button" class="btn-remove-card" data-card-id="${card.id}" aria-label="Remove card"><i class="bi bi-trash"></i></button>
                </div>
            `;
            listContainer.appendChild(item);
        });

        // Add event listeners for new buttons
        listContainer.querySelectorAll('.btn-remove-card').forEach(btn => btn.addEventListener('click', handleRemoveCard));
        listContainer.querySelectorAll('.btn-set-default').forEach(btn => btn.addEventListener('click', handleSetDefaultCard));
    }

    async function handleRemoveCard(event) {
        const cardId = event.currentTarget.dataset.cardId;
        if (!confirm('Are you sure you want to remove this card?')) return;
        try {
            const response = await fetch(`${API_BASE}/cards/${cardId}`, {
                method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Failed to remove card.');
            displayModalMessage('Card removed successfully.', 'success');
            loadSavedCards(); // Refresh lists
        } catch (error) {
            displayModalMessage(error.message || 'Could not remove card.', 'error');
        }
    }
    async function handleSetDefaultCard(event) {
        const cardId = event.currentTarget.dataset.cardId;
        try {
            const response = await fetch(`${API_BASE}/cards/${cardId}/set-default`, {
                method: 'POST', headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Failed to set default card.');
            displayModalMessage('Default card updated.', 'success');
            loadSavedCards(); // Refresh lists
        } catch (error) {
            displayModalMessage(error.message || 'Could not set default card.', 'error');
        }
    }

    // --- Deposit Submission ---
    document.getElementById('deposit-form-main')?.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!stripeInstance || !stripeElements) {
            displayFormMessage('Payment system not ready. Please refresh.', 'error');
            return;
        }
        setLoadingState(true);
        displayFormMessage('', 'clear'); // Clear previous messages

        const amount = parseFloat(document.getElementById('deposit-amount').value);
        if (isNaN(amount) || amount < 0.50) {
            displayFormMessage('Minimum deposit amount is $0.50.', 'error');
            setLoadingState(false);
            return;
        }

        const selectedPaymentMethodId = document.getElementById('select-payment-method').value;
        const isNewCard = selectedPaymentMethodId === 'new';
        const saveCard = isNewCard && document.getElementById('checkbox-save-card').checked;

        try {
            let paymentMethodToUse = selectedPaymentMethodId;
            if (isNewCard) {
                const { paymentMethod, error } = await stripeInstance.createPaymentMethod({
                    type: 'card', card: stripeCardElement,
                    // billing_details: { name: userData.username || 'VWallet User' } // Assuming userData is available
                });
                if (error) throw error;
                paymentMethodToUse = paymentMethod.id;
            }

            const intentResponse = await fetch(`${API_BASE}/deposits/payment-intent`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({
                    amount_cents: Math.round(amount * 100),
                    payment_method_id: paymentMethodToUse,
                    save_payment_method: saveCard && isNewCard // Only save if it's a new card and checkbox is checked
                })
            });
            if (!intentResponse.ok) {
                 const errorData = await intentResponse.json();
                 throw new Error(errorData.detail || 'Failed to create payment intent.');
            }
            const { client_secret, payment_intent_id } = await intentResponse.json();

            const confirmResult = await stripeInstance.confirmCardPayment(client_secret, {
                payment_method: paymentMethodToUse
            });
            if (confirmResult.error) throw confirmResult.error;

            // Confirm deposit on backend
            const backendConfirmResponse = await fetch(`${API_BASE}/deposits/confirm`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ payment_intent_id })
            });
            if (!backendConfirmResponse.ok) {
                const errorData = await backendConfirmResponse.json();
                throw new Error(errorData.detail || 'Failed to confirm deposit on server.');
            }

            displayFormMessage(`Deposit of $${amount.toFixed(2)} successful!`, 'success');
            document.getElementById('deposit-form-main').reset(); // Reset form
            if(isNewCard && stripeCardElement) stripeCardElement.clear();
            populatePaymentMethodsDropdown(currentSavedCards); // Reset dropdown to default
            loadRecentDeposits(); // Refresh recent deposits list
            if(typeof refreshUserData === 'function') refreshUserData(); // Refresh balance in sidebar if function exists

        } catch (error) {
            console.error('Deposit Error:', error);
            displayFormMessage(error.message || 'An error occurred during deposit.', 'error');
        } finally {
            setLoadingState(false);
        }
    });

    // --- Recent Deposits ---
    async function loadRecentDeposits() {
        const listContainer = document.getElementById('initial-recent-deposits');
        const loadingDiv = document.getElementById('recent-deposits-loading');
        // const viewMoreContainer = document.getElementById('view-more-deposits-btn-container');
        if (!listContainer || !loadingDiv) return;

        loadingDiv.style.display = 'flex';
        listContainer.innerHTML = '';
        // if(viewMoreContainer) viewMoreContainer.style.display = 'none';

        try {
            const response = await fetch(`${API_BASE}/deposits?limit=16`, { // Fetch last 5
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Failed to fetch recent deposits.');
            const data = await response.json();
            const deposits = data.deposits || [];

            if (deposits.length === 0) {
                listContainer.innerHTML = '<p class="text-muted p-3 text-center">No recent deposits.</p>';
            } else {
                deposits.forEach(deposit => {
                    const item = document.createElement('div');
                    item.className = 'deposit-list-item'; // Use new class
                    item.innerHTML = `
                        <span class="date">${new Date(deposit.created_at).toLocaleDateString()}</span>
                        <span class="card-details">Card **** ${deposit.card_last_four || 'N/A'}</span>
                        <span class="status">${deposit.status.charAt(0).toUpperCase() + deposit.status.slice(1)}</span>
                        <span class="amount text-success">+$${parseFloat(deposit.amount).toFixed(2)}</span>
                        <span class="info-icon"><i class="bi bi-info-circle" data-deposit-id="${deposit.id}"></i></span>
                    `;
                    listContainer.appendChild(item);
                });
                // Add listeners for new info icons
                listContainer.querySelectorAll('.info-icon i').forEach(icon => {
                    icon.addEventListener('click', (e) => showDepositDetailsModal(e.currentTarget.dataset.depositId));
                });
            }
            // Logic for "View More" can be added here if needed
        } catch (error) {
            console.error('Error loading recent deposits:', error);
            listContainer.innerHTML = '<p class="text-danger p-3 text-center">Could not load recent deposits.</p>';
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    function showDepositDetailsModal(depositId) {
        // Find deposit in currentSavedCards or fetch details
        // For now, let's assume we need to fetch, or find it in a pre-fetched detailed list
        // This is a placeholder - you'd fetch full details for the modal
        const deposit = currentSavedCards.find(d => d.id === depositId); // This is wrong, need a proper deposits list

        // Dummy data for now
        document.getElementById('detail-modal-date').textContent = 'N/A'; // Populate with actual data
        document.getElementById('detail-modal-card').textContent = 'N/A';
        document.getElementById('detail-modal-amount').textContent = 'N/A';
        document.getElementById('detail-modal-status').textContent = 'N/A';
        document.getElementById('detail-modal-ref-id').textContent = depositId || 'N/A';

        var detailsModal = new bootstrap.Modal(document.getElementById('depositDetailsModal'));
        detailsModal.show();
    }

    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', async () => {
        await initializeStripeElements();
        await loadSavedCards();
        await loadRecentDeposits();

        document.getElementById('open-manage-cards-modal')?.addEventListener('click', () => {
            var manageCardsModal = new bootstrap.Modal(document.getElementById('manageCardsModal'));
            populateManageCardsModal(currentSavedCards); // Ensure it's up-to-date
            manageCardsModal.show();
        });

        document.getElementById('btn-refresh-on-error')?.addEventListener('click', () => window.location.reload());

        // Toggle for recent deposits
        const depositsToggle = document.getElementById('toggle-recent-deposits');
        const depositsListContent = document.getElementById('recent-deposits-list-content');
        const depositsArrow = depositsToggle?.querySelector('i.bi-chevron-down');

        if (depositsToggle && depositsListContent && depositsArrow) {
            // Start collapsed
            depositsListContent.classList.remove('show');
            depositsListContent.style.maxHeight = '0px';
            depositsListContent.style.opacity = '0';
            depositsArrow.classList.remove('up');
            depositsToggle.setAttribute('aria-expanded', 'false');


            depositsToggle.addEventListener('click', () => {
                const isCurrentlyShown = depositsListContent.classList.toggle('show');
                depositsToggle.setAttribute('aria-expanded', isCurrentlyShown.toString());
                depositsArrow.classList.toggle('up', isCurrentlyShown);

                if (isCurrentlyShown) {
                    depositsListContent.style.maxHeight = depositsListContent.scrollHeight + 'px';
                    depositsListContent.style.opacity = '1';
                    setTimeout(() => { // Allow dynamic content changes
                        if(depositsListContent.classList.contains('show')) depositsListContent.style.maxHeight = '2500px';
                    }, 500);
                } else {
                    depositsListContent.style.maxHeight = depositsListContent.scrollHeight + 'px';
                    depositsListContent.offsetHeight; // Trigger reflow
                    depositsListContent.style.maxHeight = '0px';
                    depositsListContent.style.opacity = '0';
                }
            });
        }

        document.dispatchEvent(new CustomEvent('pageContentLoaded'));
    });

</script>
{% endblock %}