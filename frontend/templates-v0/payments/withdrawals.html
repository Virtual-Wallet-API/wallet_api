{% extends "base.html" %}

{% block styles %}
<style type="text/css">
    /* Main Content Alignment */
    .main-content {
        /* Styles inherited from base.html, ensure padding is appropriate */
        /* padding-top: 2rem; /* Adjust if needed, base.html has 2rem */
    }

    .withdrawal-page-container {
        max-width: 800px; /* Max width for the content on this page */
        margin: 0 auto; /* Center the content */
        padding: 0 1rem; /* Padding for smaller screens */
    }

    /* Withdrawal Title */
    .withdrawal-title-main { /* More specific class */
        font-size: 2.25rem;
        font-weight: 700;
        margin-bottom: 2.5rem;
        text-align: center;
        color: var(--accent-color);
        font-family: 'Inter', sans-serif; /* Consistent font */
    }

    /* Withdrawal Box Styles - Enhanced */
    .withdrawal-form-box { /* Renamed for clarity */
        position: relative;
        width: 100%;
        padding: 2rem 2.5rem; /* Adjusted padding */
        background: var(--background-color); /* Use page background or a subtle card background */
        border: 1px solid var(--bs-border-color); /* Theme border */
        border-radius: 1rem; /* Consistent rounding */
        box-shadow: var(--transaction-shadow); /* Use theme shadow */
        transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out, padding 0.5s ease-in-out, margin-bottom 0.5s ease-in-out;
        font-family: 'Inter', sans-serif;
        font-size: 1rem; /* Base font size for form */
        overflow: hidden;
        max-height: 1200px; /* Increased default max-height */
        margin-bottom: 2.5rem;
    }
    [data-bs-theme="dark"] .withdrawal-form-box {
        background: var(--bs-tertiary-bg); /* Slightly different from page bg in dark mode */
    }

    .withdrawal-form-box.hidden {
        max-height: 0 !important;
        opacity: 0 !important;
        padding-top: 0;
        padding-bottom: 0;
        margin-bottom: 0 !important;
        border-width: 0; /* Hide border when collapsed */
    }

    /* Balance Display */
    .balance-display {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--accent-color);
        margin-bottom: 2rem;
        text-align: center;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
    }

    #balance-amount-loading {
        position: absolute;
        font-size: 1.5rem;
        opacity: 1;
        transition: opacity 0.35s ease-in-out;
    }

    #balance-amount-loading.hidden {
        opacity: 0;
    }

    #balance-text, #balance-amount {
        transition: opacity 0.35s ease-in-out;
    }

    /* Form Elements - Enhanced */
    .form-group {
        margin-bottom: 1.75rem; /* Adjusted spacing */
    }

    .form-group label {
        display: block;
        margin-bottom: 0.6rem; /* Reduced space */
        font-weight: 500;
        color: var(--text-color);
        font-size: 0.95rem; /* Slightly smaller label */
    }

    .form-control, .form-select { /* Common styling for form inputs */
        background-color: var(--bs-body-bg); /* Use Bootstrap's body background for inputs */
        border: 1px solid var(--bs-border-color); /* Theme border */
        border-radius: 0.5rem; /* Standardized rounding */
        padding: 0.875rem 1rem; /* Adjusted padding */
        font-size: 1rem; /* Standardized font size */
        color: var(--text-color); /* Theme text color */
        width: 100%;
        box-sizing: border-box;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
        font-family: 'Inter', sans-serif;
    }
    [data-bs-theme="dark"] .form-control, [data-bs-theme="dark"] .form-select {
        background-color: var(--bs-tertiary-bg); /* Darker input background */
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--accent-color);
        box-shadow: 0 0 0 0.2rem rgba(var(--accent-color-rgb), 0.25); /* Bootstrap-like focus */
        outline: none;
    }

    /* Input Groups - Enhanced */
    .amount-input-group, .card-select-input-group { /* Renamed for clarity */
        display: flex;
        align-items: stretch; /* Ensure items stretch to full height */
        height: calc(1.5em + 1.75rem + 2px); /* Match Bootstrap input height */
    }

    .input-group-text-custom { /* Replaces .currency-display and .card-select-icon */
        background-color: var(--bs-secondary-bg); /* Subtle background */
        color: var(--text-color);
        border: 1px solid var(--bs-border-color);
        padding: 0.875rem 1rem;
        font-size: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-right: none;
        border-radius: 0.5rem 0 0 0.5rem;
    }
    .input-group-text-custom i.bi { /* Icon within the text part */
        font-size: 1.25rem;
    }

    .amount-input-group .form-control, .card-select-input-group .form-select {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
        flex-grow: 1;
        height: 100%; /* Ensure it fills the group height */
    }

    .card-select-input-group {
        position: relative; /* For dropdown arrow */
    }
    .card-select-input-group .form-select { /* Select specific */
        padding-right: 2.5rem; /* Space for arrow */
        appearance: none; /* Remove default select arrow */
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
    }
    [data-bs-theme="dark"] .card-select-input-group .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23adb5bd' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
    }

    /* Confirm Button - Enhanced */
    .btn-confirm-withdrawal { /* Renamed for specificity */
        background-color: var(--accent-color);
        border-color: var(--accent-color);
        color: var(--sidebar-text-color); /* Assuming light text on accent */
        padding: 0.875rem 1.5rem;
        font-size: 1.1rem; /* Adjusted size */
        font-weight: 600;
        border-radius: 0.5rem;
        width: 100%;
        margin-top: 1rem; /* Space above button */
        transition: background-color 0.2s ease, border-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-confirm-withdrawal:hover:not(:disabled) {
        background-color: var(--accent-color-hover);
        border-color: var(--accent-color-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(var(--accent-color-rgb), 0.25);
    }
    .btn-confirm-withdrawal:disabled {
        opacity: 0.65; /* Bootstrap default */
        cursor: not-allowed;
    }
    [data-bs-theme="dark"] .btn-confirm-withdrawal {
        color: var(--text-color); /* Or specific dark theme button text color */
    }

    /* Message Styles - Enhanced */
    .form-message { /* Common class for success/error messages */
        max-height: 0;
        opacity: 0;
        padding: 0 1rem; /* Horizontal padding when visible */
        margin: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out, padding 0.3s ease-out, margin-top 0.3s ease-out;
        border-radius: 0.5rem;
        font-size: 0.95rem;
    }
    .form-message.visible {
        margin-top: 1rem; /* Space above message */
        max-height: 100px; /* Adjust as needed */
        opacity: 1;
        padding: 0.75rem 1rem; /* Vertical padding when visible */
    }
    .form-message.alert-success { /* Bootstrap success colors */
        color: var(--bs-success-text-emphasis);
        background-color: var(--bs-success-bg-subtle);
        border: 1px solid var(--bs-success-border-subtle);
    }
    .form-message.alert-danger { /* Bootstrap danger colors */
        color: var(--bs-danger-text-emphasis);
        background-color: var(--bs-danger-bg-subtle);
        border: 1px solid var(--bs-danger-border-subtle);
    }

    /* Header Toggle for Recent Withdrawals */
    .section-toggle-withdrawals {
        color: var(--text-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        width: 100%;
        padding: 1rem 1.5rem;
        background: var(--balance-bg);
        border-radius: 0.75rem;
        font-family: 'Inter', sans-serif;
        margin-bottom: 1rem;
        box-shadow: 0 2px 5px rgba(var(--accent-color-rgb), 0.08);
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
        margin-top: 2.5rem; /* Space above this section */
    }
    .section-toggle-withdrawals:hover {
        background-color: rgba(var(--accent-color-rgb), 0.05);
        box-shadow: 0 4px 8px rgba(var(--accent-color-rgb), 0.12);
    }
    .section-toggle-withdrawals h3 {
        margin: 0; font-size: 1.25rem; font-weight: 600; color: var(--text-color);
    }
    .section-toggle-withdrawals i.bi-chevron-down {
        font-size: 1.25rem; color: var(--accent-color); transition: transform 0.3s ease;
    }
    .section-toggle-withdrawals i.bi-chevron-down.up { transform: rotate(180deg); }

    /* Recent Withdrawals List */
    .recent-withdrawals-list {
        background-color: var(--background-color);
        border-radius: 0.75rem;
        overflow: hidden;
        max-height: 0;
        opacity: 0;
        transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out, padding-top 0.5s ease-in-out, padding-bottom 0.5s ease-in-out;
        padding-top: 0;
        padding-bottom: 0;
    }
    .recent-withdrawals-list.show {
        max-height: 2500px; opacity: 1; padding-top: 1rem; padding-bottom: 1rem;
    }

    /* Withdrawal Item */
    .withdrawal-list-item {
        display: flex; justify-content: space-between; align-items: center;
        padding: 1rem 1.5rem; border-bottom: 1px solid var(--bs-border-color);
        transition: background-color 0.2s ease; cursor: pointer; font-family: 'Inter', sans-serif;
    }
    .withdrawal-list-item:last-child { border-bottom: none; }
    .withdrawal-list-item:hover { background-color: rgba(var(--accent-color-rgb), 0.03); }
    .withdrawal-list-item .date, .withdrawal-list-item .card-details, .withdrawal-list-item .status {
        font-size: 0.95rem; color: var(--text-color); opacity: 0.9; flex-basis: 30%;
    }
    .withdrawal-list-item .card-details { flex-grow: 1; }
    .withdrawal-list-item .amount {
        font-size: 1rem; font-weight: 600; color: var(--bs-danger);
        min-width: 100px; text-align: right; flex-basis: 20%;
    }
    .withdrawal-list-item .info-icon {
        font-size: 1.1rem; color: var(--accent-color); opacity: 0.7;
        transition: opacity 0.2s ease; flex-basis: 10%; text-align: right;
    }
    .withdrawal-list-item:hover .info-icon { opacity: 1; }

    /* Manage Cards Button in Form */
    .label-button-container {
        display: flex;
        justify-content: space-between;
        align-items: center; /* Align label and button */
        margin-bottom: 0.6rem; /* Match label margin */
    }
    .btn-manage-cards { /* Renamed for specificity */
        background-color: transparent;
        color: var(--accent-color);
        border: 1px solid var(--accent-color);
        border-radius: 0.375rem; /* Smaller radius for smaller button */
        padding: 0.3rem 0.8rem;
        font-size: 0.85rem;
        font-weight: 500;
        font-family: 'Inter', sans-serif;
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease, transform 0.2s ease;
    }
    .btn-manage-cards:hover {
        background-color: rgba(var(--accent-color-rgb), 0.1);
        transform: translateY(-1px);
    }
    .btn-manage-cards i.bi {
        margin-right: 0.3rem;
    }

    /* Loading Container */
    .list-loading-container {
        font-size: 2rem;
        text-align: center;
        width: 100%;
        display: flex;
        color: var(--accent-color);
        justify-content: center;
        align-items: center;
        margin: 1.5rem auto;
        max-height: 100px;
        opacity: 1;
        transition: max-height 1s ease-in-out, opacity 0.7s ease-in-out;
    }

    .list-loading-container.hidden {
        max-height: 0;
        opacity: 0;
        padding: 0 !important;
        margin: 0 !important;
    }

    .bi-arrow-repeat {
        display: inline-block;
        animation: spin 1.5s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Modal Styles - Enhanced */
    .modal-manage-cards .modal-content, .modal-withdrawal-details .modal-content {
        font-family: 'Inter', sans-serif;
        background: var(--background-color);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.75rem;
    }
    .modal-manage-cards .modal-header, .modal-withdrawal-details .modal-header {
        border-bottom: 1px solid var(--bs-border-color); padding: 1rem 1.5rem;
    }
    .modal-manage-cards .modal-title, .modal-withdrawal-details .modal-title {
        font-size: 1.25rem; font-weight: 600; color: var(--text-color);
    }
    .modal-manage-cards .modal-body, .modal-withdrawal-details .modal-body { padding: 1.5rem; }
    .modal-manage-cards .modal-footer, .modal-withdrawal-details .modal-footer {
        border-top: 1px solid var(--bs-border-color); padding: 1rem 1.5rem;
    }

    .saved-card-entry {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.875rem 1rem;
        margin-bottom: 0.5rem;
        background: var(--bs-secondary-bg);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        font-size: 0.95rem;
        color: var(--text-color);
        transition: background-color 0.2s ease;
    }
    .saved-card-entry:hover {
        background-color: var(--bs-tertiary-bg);
    }
    .saved-card-entry .card-info { display: flex; align-items: center; gap: 0.75rem; flex-grow: 1; }
    .saved-card-entry .card-icon { font-size: 1.25rem; color: var(--accent-color); }
    .saved-card-entry .card-actions { display: flex; align-items: center; gap: 0.5rem; }
    .saved-card-entry .default-badge {
        background-color: var(--accent-color); color: white;
        padding: 0.25rem 0.6rem; border-radius: 0.25rem; font-size: 0.75rem; font-weight: 500;
    }
    .btn-remove-card {
        background: transparent; border: none; color: var(--bs-danger); padding: 0.25rem;
        opacity: 0.7; transition: opacity 0.2s ease;
    }
    .btn-remove-card:hover { opacity: 1; }
    .btn-remove-card i.bi { font-size: 1.1rem; vertical-align: middle; }

    /* Withdrawal Details Modal */
    .modal-withdrawal-details .modal-body p { font-size: 1rem; margin-bottom: 0.75rem; }
    .modal-withdrawal-details .modal-body p strong { font-weight: 600; color: var(--accent-color); }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .withdrawal-page-container { padding: 0 0.75rem; }
        .withdrawal-title-main { font-size: 1.8rem; margin-bottom: 1.5rem; }
        .withdrawal-form-box { padding: 1.5rem; font-size: 0.95rem; }
        .form-group { margin-bottom: 1.25rem; }
        .form-control, .form-select, .input-group-text-custom { font-size: 0.95rem; padding: 0.75rem; }
        .amount-input-group, .card-select-input-group { height: calc(1.5em + 1.5rem + 2px); }
        .btn-confirm-withdrawal { font-size: 1rem; padding: 0.75rem 1.25rem; }
        .section-toggle-withdrawals h3 { font-size: 1.1rem; }
        .withdrawal-list-item { font-size: 0.9rem; padding: 0.75rem 1rem; }
        .balance-display { font-size: 1.25rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="withdrawal-page-container">
    <h2 class="withdrawal-title-main">Withdraw Cash</h2>

    <!-- Withdrawal Box -->
    <div class="withdrawal-form-box" id="withdrawal-box">
        <div class="form-message alert alert-success" id="success-message" style="display: none;"></div>
        <div class="form-message alert alert-danger" id="error-message" style="display: none;"></div>

        <form id="withdrawal-form" method="POST">
            <!-- Balance Display -->
            <div class="balance-display" id="balance-display">
                <span id="balance-text" style="opacity: 0;">Available Balance:</span>
                <span id="balance-amount" style="opacity: 0;">$0.00</span>
                <span id="balance-amount-loading" class="hidden"><i class="bi bi-arrow-repeat"></i></span>
            </div>

            <!-- Card Selection -->
            <div class="form-group">
                <div class="label-button-container">
                    <label for="card-select">Select Card</label>
                    <button class="btn-manage-cards" id="manage-cards-button" type="button">
                        <i class="bi bi-gear"></i> Manage Cards
                    </button>
                </div>
                <div class="card-select-input-group">
                    <span class="input-group-text-custom"><i class="bi bi-credit-card" id="selected-card-brand-icon"></i></span>
                    <select class="form-select" id="card-select" required>
                        <option value="" disabled selected>Select a card</option>
                    </select>
                </div>
            </div>

            <!-- Amount Input -->
            <div class="form-group">
                <label for="withdrawal-amount">Amount</label>
                <div class="amount-input-group">
                    <span class="input-group-text-custom">USD</span>
                    <input class="form-control" id="withdrawal-amount" min="0.50" max="10000"
                           placeholder="Enter amount" required step="0.01" type="number">
                </div>
                <div class="form-message alert-danger" id="amount-error" style="display: none;"></div>
            </div>

            <!-- Submit Button -->
            <button class="btn btn-confirm-withdrawal" id="submit-button" type="submit">
                <span id="button-text">Confirm Withdrawal</span>
                <span id="spinner" style="display: none;"><i class="bi bi-arrow-repeat"></i> Processing...</span>
            </button>
        </form>
    </div>

    <!-- Recent Withdrawals Section -->
    <div class="section-toggle-withdrawals" id="withdrawals-toggle" tabindex="0" aria-expanded="false" aria-controls="recent-withdrawals-list-content">
        <h3>Recent Withdrawals</h3>
        <i class="bi bi-chevron-down"></i>
    </div>
    <div class="recent-withdrawals-list" id="recent-withdrawals-list-content">
        <div class="list-loading-container" id="withdrawals-loading"><i class="bi bi-arrow-repeat"></i></div>
        <div id="initial-withdrawals">
            <!-- Withdrawal items will be inserted here by JS -->
        </div>
        <div id="additional-withdrawals" class="items-list-more" style="max-height: 0; opacity: 0; overflow: hidden;">
            <!-- Additional withdrawal items -->
        </div>
        <div class="view-more-button-container" id="view-more-withdrawals-btn-container" style="display: none;">
            <a class="btn btn-outline-primary btn-view-more" href="#" id="view-withdrawals-btn">View More</a>
        </div>
    </div>
    <!-- Add padding to clear fixed footer -->
    <div style="padding-bottom: 80px;"></div>
</div>
{% endblock %}

{% block modals %}
<!-- Modal for Managing Saved Cards -->
<div class="modal fade modal-manage-cards" id="manageCardsModal" tabindex="-1" aria-labelledby="manageCardsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manageCardsModalLabel">Manage Saved Cards</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="form-message alert alert-danger" id="modal-error-message" style="display: none;"></div>
                <div class="form-message alert alert-success" id="modal-success-message" style="display: none;"></div>
                <div id="saved-cards-list">
                    <!-- Saved cards list populated by JS -->
                    <p id="no-saved-cards-message" style="display:none;">You have no saved cards.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Withdrawal Details Modal -->
<div class="modal fade modal-withdrawal-details" id="withdrawalModal" tabindex="-1" aria-labelledby="withdrawalModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="withdrawalModalLabel">Withdrawal Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Date:</strong> <span id="modal-date"></span></p>
                <p><strong>Card:</strong> <span id="modal-card"></span></p>
                <p><strong>Amount:</strong> <span id="modal-amount"></span></p>
                <p><strong>Status:</strong> <span id="modal-status"></span></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentSavedCards = []; // To store fetched saved cards

    const brandIconClasses = {
        visa: 'bi bi-credit-card-2-front-fill',
        mastercard: 'bi bi-credit-card-fill',
        amex: 'bi bi-credit-card-fill',
        discover: 'bi bi-credit-card',
        diners: 'bi bi-credit-card',
        jcb: 'bi bi-credit-card',
        unionpay: 'bi bi-credit-card',
        unknown: 'bi bi-credit-card',
        default: 'bi bi-credit-card'
    };

    function getCardBrandIcon(brand) {
        return brandIconClasses[brand?.toLowerCase()] || brandIconClasses.default;
    }

    // --- UI Helper Functions ---
    function setLoadingState(isLoading) {
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const spinner = document.getElementById('spinner');
        const formBox = document.getElementById('withdrawal-box');

        if (submitButton && buttonText && spinner && formBox) {
            submitButton.disabled = isLoading;
            buttonText.style.display = isLoading ? 'none' : 'inline';
            spinner.style.display = isLoading ? 'inline-block' : 'none';
            formBox.classList.toggle('form-loading', isLoading);
        }
    }

    function displayFormMessage(message, type = 'error') {
        const messageId = type === 'success' ? 'success-message' : 'error-message';
        const messageDiv = document.getElementById(messageId);
        const otherMessageId = type === 'success' ? 'error-message' : 'success-message';
        const otherMessageDiv = document.getElementById(otherMessageId);

        if (otherMessageDiv) {
            otherMessageDiv.classList.remove('visible');
            otherMessageDiv.style.display = 'none';
        }
        if (messageDiv) {
            messageDiv.textContent = message;
            messageDiv.className = `form-message alert alert-${type === 'success' ? 'success' : 'danger'} visible`;
            messageDiv.style.display = 'block';
            messageDiv.setAttribute('role', 'alert');

            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.classList.remove('visible');
                messageDiv.style.display = 'none';
            }, 5000);
        }
    }

    function displayModalMessage(message, type = 'error') {
        const messageId = type === 'success' ? 'modal-success-message' : 'modal-error-message';
        const messageDiv = document.getElementById(messageId);
        const otherMessageId = type === 'success' ? 'modal-error-message' : 'modal-success-message';
        const otherMessageDiv = document.getElementById(otherMessageId);

        if (otherMessageDiv) otherMessageDiv.style.display = 'none';
        if (messageDiv) {
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            setTimeout(() => { messageDiv.style.display = 'none'; }, 5000);
        }
    }

    // --- Card Functions ---
    async function loadSavedCards() {
        if (!token) return;
        try {
            const response = await fetch(`${API_BASE}/cards`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Failed to fetch saved cards.');

            const data = await response.json();
            currentSavedCards = data.cards || [];
            populateCardDropdown(currentSavedCards);
            populateManageCardsModal(currentSavedCards);
        } catch (error) {
            console.error('Error loading saved cards:', error);
            displayFormMessage('Could not load saved cards.', 'error');
            populateCardDropdown([]);
        }
    }

    function populateCardDropdown(cards) {
        const selectEl = document.getElementById('card-select');
        const cardIconEl = document.getElementById('selected-card-brand-icon');

        selectEl.innerHTML = '<option value="" disabled selected>Select a card</option>';

        let defaultSelected = '';
        cards.forEach(card => {
            const option = document.createElement('option');
            option.value = card.id;
            option.textContent = `${card.brand ? card.brand.charAt(0).toUpperCase() + card.brand.slice(1) : 'Card'} **** ${card.last_four} (Exp: ${card.exp_month}/${String(card.exp_year).slice(2)})`;
            option.dataset.brand = card.brand;
            selectEl.appendChild(option);
            if (card.is_default) defaultSelected = card.id;
        });

        if (defaultSelected) selectEl.value = defaultSelected;

        function updateIconForSelection() {
            const selectedValue = selectEl.value;
            const selectedOption = selectEl.querySelector(`option[value="${selectedValue}"]`);
            const brand = selectedOption ? selectedOption.dataset.brand : 'default';
            cardIconEl.className = getCardBrandIcon(brand);
        }
        selectEl.addEventListener('change', updateIconForSelection);
        updateIconForSelection();
    }

    function populateManageCardsModal(cards) {
        const listContainer = document.getElementById('saved-cards-list');
        const noCardsMsg = document.getElementById('no-saved-cards-message');
        listContainer.innerHTML = '';

        if (cards.length === 0) {
            if(noCardsMsg) noCardsMsg.style.display = 'block';
            return;
        }
        if(noCardsMsg) noCardsMsg.style.display = 'none';

        cards.forEach(card => {
            const item = document.createElement('div');
            item.className = 'saved-card-entry';
            item.innerHTML = `
                <div class="card-info">
                    <i class="${getCardBrandIcon(card.brand)} card-icon"></i>
                    <span>${card.brand ? card.brand.charAt(0).toUpperCase() + card.brand.slice(1) : 'Card'} **** ${card.last_four} (Exp: ${card.exp_month}/${String(card.exp_year).slice(2)})</span>
                </div>
                <div class="card-actions">
                    ${card.is_default ? '<span class="default-badge">Default</span>' : `<button type="button" class="btn btn-sm btn-outline-secondary btn-set-default" data-card-id="${card.id}">Set Default</button>`}
                    <button type="button" class="btn-remove-card" data-card-id="${card.id}" aria-label="Remove card"><i class="bi bi-trash"></i></button>
                </div>
            `;
            listContainer.appendChild(item);
        });

        listContainer.querySelectorAll('.btn-remove-card').forEach(btn => btn.addEventListener('click', handleRemoveCard));
        listContainer.querySelectorAll('.btn-set-default').forEach(btn => btn.addEventListener('click', handleSetDefaultCard));
    }

    async function handleRemoveCard(event) {
        const cardId = event.currentTarget.dataset.cardId;
        if (!confirm('Are you sure you want to remove this card?')) return;
        try {
            const response = await fetch(`${API_BASE}/cards/${cardId}`, {
                method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Failed to remove card.');
            displayModalMessage('Card removed successfully.', 'success');
            loadSavedCards();
        } catch (error) {
            displayModalMessage(error.message || 'Could not remove card.', 'error');
        }
    }

    async function handleSetDefaultCard(event) {
        const cardId = event.currentTarget.dataset.cardId;
        try {
            const response = await fetch(`${API_BASE}/cards/${cardId}/set-default`, {
                method: 'POST', headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Failed to set default card.');
            displayModalMessage('Default card updated.', 'success');
            loadSavedCards();
        } catch (error) {
            displayModalMessage(error.message || 'Could not set default card.', 'error');
        }
    }

    // --- Withdrawal Functions ---
    async function loadRecentWithdrawals() {
        const listContainer = document.getElementById('initial-withdrawals');
        const loadingDiv = document.getElementById('withdrawals-loading');
        if (!listContainer || !loadingDiv) return;

        loadingDiv.style.display = 'flex';
        listContainer.innerHTML = '';

        try {
            const response = await fetch(`${API_BASE}/withdrawals?limit=16`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (!response.ok) throw new Error('Failed to fetch recent withdrawals.');
            const data = await response.json();
            console.log(data); // todo-remove
            const withdrawals = data.withdrawals || [];

            if (withdrawals.length === 0) {
                listContainer.innerHTML = '<p class="text-muted p-3 text-center">No recent withdrawals.</p>';
            } else {
                withdrawals.forEach(withdrawal => {
                    const item = document.createElement('div');
                    item.className = 'withdrawal-list-item';
                    item.innerHTML = `
                        <span class="date">${new Date(withdrawal.created_at).toLocaleDateString()}</span>
                        <span class="card-details">Card **** ${withdrawal.card_info?.last_four || 'N/A'}</span>
                        <span class="status">${withdrawal.status.charAt(0).toUpperCase() + withdrawal.status.slice(1)}</span>
                        <span class="amount text-danger">-$${Math.abs(withdrawal.amount).toFixed(2)}</span>
                        <span class="info-icon"><i class="bi bi-info-circle" data-withdrawal-id="${withdrawal.id}"></i></span>
                    `;
                    listContainer.appendChild(item);
                });
                listContainer.querySelectorAll('.info-icon i').forEach(icon => {
                    icon.addEventListener('click', (e) => showWithdrawalDetailsModal(e.currentTarget.dataset.withdrawalId));
                });
            }
        } catch (error) {
            console.error('Error loading recent withdrawals:', error);
            listContainer.innerHTML = '<p class="text-danger p-3 text-center">Could not load recent withdrawals.</p>';
        } finally {
            loadingDiv.style.display = 'none';
        }
    }

    function showWithdrawalDetailsModal(withdrawalId) {
        // Placeholder - you'd fetch full details for the modal
        document.getElementById('modal-date').textContent = 'N/A';
        document.getElementById('modal-card').textContent = 'N/A';
        document.getElementById('modal-amount').textContent = 'N/A';
        document.getElementById('modal-status').textContent = 'N/A';

        var detailsModal = new bootstrap.Modal(document.getElementById('withdrawalModal'));
        detailsModal.show();
    }

    // --- Form Submission ---
    document.getElementById('withdrawal-form')?.addEventListener('submit', async (event) => {
        event.preventDefault();
        const cardId = document.getElementById('card-select').value;
        const amount = parseFloat(document.getElementById('withdrawal-amount').value);

        if (!cardId) {
            displayFormMessage('Please select a card.', 'error');
            return;
        }
        if (isNaN(amount) || amount < 0.50) {
            displayFormMessage('Please enter a valid amount (minimum $0.50).', 'error');
            return;
        }
        if (amount > parseFloat(userData.balance)) {
            displayFormMessage('Insufficient balance.', 'error');
            return;
        }

        setLoadingState(true);

        try {
            const response = await fetch(`${API_BASE}/withdrawals`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    amount_cents: Math.round(amount * 100),
                    card_id: cardId,
                    currency_code: "USD",
                    withdrawal_type: "payout",
                    method: "card",
                    description: "Default description"
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Failed to process withdrawal');
            }

            displayFormMessage(`Withdrawal request of $${amount.toFixed(2)} submitted successfully!`, 'success');
            await updateBalancePostWithdrawal(amount)
            document.getElementById('withdrawal-form').reset();
            populateCardDropdown(currentSavedCards);
            loadRecentWithdrawals();
            if(typeof refreshUserData === 'function') refreshUserData();

        } catch (error) {
            console.error('Withdrawal Error:', error);
            displayFormMessage(error.message || 'An error occurred during withdrawal.', 'error');
        } finally {
            setLoadingState(false);
        }
    });

    async function updateBalancePostWithdrawal(amount = 0) {
        const balanceAmount = document.getElementById('balance-amount');
        const balanceText = document.getElementById('balance-text');
        const balanceLoading = document.getElementById('balance-amount-loading');
        setTimeout(() => {
            balanceAmount.textContent = `$${(userData.balance - amount).toFixed(2)}`;
        }, 150);
        refreshUserData()
    }


    // --- Initial Setup ---
    document.addEventListener('DOMContentLoaded', async () => {
        // Update balance display
        const balanceAmount = document.getElementById('balance-amount');
        const balanceText = document.getElementById('balance-text');
        const balanceLoading = document.getElementById('balance-amount-loading');

        balanceLoading.classList.remove('hidden');
        if (!userData.balance) {
            await refreshUserData();
        }

        await loadSavedCards();

        setTimeout(() => {
            balanceLoading.classList.add('hidden');
            balanceAmount.textContent = `$${userData.balance}`;
            balanceAmount.style.opacity = '1';
            balanceText.style.opacity = '1';
        }, 350);

        document.dispatchEvent(new CustomEvent('pageContentLoaded'));

        document.getElementById('manage-cards-button')?.addEventListener('click', () => {
            var manageCardsModal = new bootstrap.Modal(document.getElementById('manageCardsModal'));
            populateManageCardsModal(currentSavedCards);
            manageCardsModal.show();
        });

        // Toggle for recent withdrawals
        const withdrawalsToggle = document.getElementById('withdrawals-toggle');
        const withdrawalsListContent = document.getElementById('recent-withdrawals-list-content');
        const withdrawalsArrow = withdrawalsToggle?.querySelector('i.bi-chevron-down');

        if (withdrawalsToggle && withdrawalsListContent && withdrawalsArrow) {
            // Start collapsed
            withdrawalsListContent.classList.remove('show');
            withdrawalsListContent.style.maxHeight = '0px';
            withdrawalsListContent.style.opacity = '0';
            withdrawalsArrow.classList.remove('up');
            withdrawalsToggle.setAttribute('aria-expanded', 'false');

            withdrawalsToggle.addEventListener('click', () => {
                const isCurrentlyShown = withdrawalsListContent.classList.toggle('show');
                withdrawalsToggle.setAttribute('aria-expanded', isCurrentlyShown.toString());
                withdrawalsArrow.classList.toggle('up', isCurrentlyShown);

                if (isCurrentlyShown) {
                    loadRecentWithdrawals(); // Load data when expanding
                    withdrawalsListContent.style.maxHeight = withdrawalsListContent.scrollHeight + 'px';
                    withdrawalsListContent.style.opacity = '1';
                    setTimeout(() => {
                        if(withdrawalsListContent.classList.contains('show')) withdrawalsListContent.style.maxHeight = '2500px';
                    }, 500);
                } else {
                    withdrawalsListContent.style.maxHeight = withdrawalsListContent.scrollHeight + 'px';
                    withdrawalsListContent.offsetHeight;
                    withdrawalsListContent.style.maxHeight = '0px';
                    withdrawalsListContent.style.opacity = '0';
                }
            });
        }

        document.dispatchEvent(new CustomEvent('pageContentLoaded'));
    });
</script>
{% endblock %}