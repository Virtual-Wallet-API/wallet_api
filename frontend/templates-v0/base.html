<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>{{ page | capitalize() }} - VWallet</title>

    <!-- JavaScript Dependencies -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript">
        // API Configuration
        const API_BASE = '/api/v1';
        const FE_BASE = '/fe';

        // Utility function to get cookie by name
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
            return null;
        }

        // Set token
        const token = getCookie('access_token');
    </script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts (Inter for a more modern UI feel) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html * {
            transition: all 0.3s ease; /* Consider scoping this more if performance issues arise */
        }

        /* Theme Variables */
        [data-bs-theme="light"] {
            --hero-gradient: linear-gradient(135deg, #6f42c1, #533c9f);
            --sidebar-bg: linear-gradient(180deg, #6f42c1 0%, #533c9f 100%); /* New sidebar specific gradient */
            --sidebar-text-color: #ffffff;
            --sidebar-icon-color: #ffffff;
            --sidebar-active-bg: rgba(255, 255, 255, 0.15);
            --sidebar-hover-bg: rgba(255, 255, 255, 0.1);
            --sidebar-logo-bg: transparent; /* Original was --accent-color */

            --background-color: #f5f5f5;
            --text-color: #000000;
            --accent-color: #6f42c1;
            --accent-color-rgb: 111, 66, 193;
            --accent-color-hover: #533c9f;
            --balance-bg: linear-gradient(135deg, #f8f9fa, #e9ecef);
            --shadow-color: rgba(var(--accent-color-rgb), 0.25);
            --balance-outer-shadow: 0 5px 10px var(--shadow-color);
            --balance-inner-shadow: inset 0 1px 2px rgba(var(--accent-color-rgb), 0.2);
            --transaction-shadow: 0 3px 6px var(--shadow-color);
            --footer-bg: #e9ecef;
            --footer-text: #333;
            --footer-link: #6f42c1;
            --footer-link-hover: #533c9f;
        }

        [data-bs-theme="dark"] {
            --hero-gradient: linear-gradient(135deg, #3700b3, #121212);
            --sidebar-bg: linear-gradient(180deg, #2a214a 0%, #1e1a35 100%); /* Darker, subtle gradient */
            --sidebar-text-color: #e0e0e0;
            --sidebar-icon-color: #bb86fc;
            --sidebar-active-bg: rgba(187, 134, 252, 0.15); /* Accent color with alpha */
            --sidebar-hover-bg: rgba(187, 134, 252, 0.1);  /* Accent color with alpha */
            --sidebar-logo-bg: transparent;

            --background-color: #121212;
            --text-color: #ffffff;
            --accent-color: #bb86fc;
            --accent-color-rgb: 187, 134, 252;
            --accent-color-hover: #3700b3;
            --balance-bg: linear-gradient(135deg, #333, #222);
            --shadow-color: rgba(42, 0, 95, 0.6);
            --balance-outer-shadow: 0 5px 10px var(--shadow-color);
            --balance-inner-shadow: inset 0 1px 2px rgba(42, 0, 95, 0.4);
            --transaction-shadow: none;
            --footer-bg: #222;
            --footer-text: #ffffff;
            --footer-link: #bb86fc;
            --footer-link-hover: #3700b3;
        }

        body {
            font-family: 'Inter', sans-serif; /* Switched to Inter */
            background: var(--background-color);
            color: var(--text-color);
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        /* Loading Screen (no changes) */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 25%; /* Assuming sidebar is always 25% on desktop */
            width: 75%;
            height: 100vh;
            background: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        /*[data-bs-theme="dark"] .loading-screen { !* Ensure loading screen matches dark theme bg *!*/
        /*     left: 0; width: 100%; !* Cover full screen before sidebar potentially renders *!*/
        /*}*/
         @media (max-width: 767.98px) {
            .loading-screen {
                left: 0;
                width: 100%;
            }
        }


        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loading-spinner {
            font-size: 3.5rem; /* Slightly smaller */
            color: var(--accent-color);
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .container-fluid { padding: 0; margin: 0; overflow: hidden; }

        /* Sidebar Styles - IMPROVED */
        .sidebar {
            background: var(--sidebar-bg); /* Use new sidebar background variable */
            color: var(--sidebar-text-color);
            height: 100vh;
            position: fixed;
            top: 0;
            left:0; /* Ensure it's anchored to the left */
            width: 25%;
            transition: background 0.3s ease, width 0.3s ease; /* Added width transition */
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1); /* Softer shadow */
            padding: 1.5rem 0; /* Vertical padding, horizontal handled by items */
            display: flex;
            flex-direction: column;
        }

        .sidebar-logo-wrapper { /* New wrapper for better control */
            padding: 0 1.5rem; /* Horizontal padding for logo */
            margin-bottom: 2rem;
        }

        .sidebar-logo {
            display: flex;
            flex-direction: column; /* Keep column for icon and text */
            align-items: center; /* Center items */
            text-align: center;
            padding: 1rem 0; /* Adjust padding */
            background: var(--sidebar-logo-bg); /* Use variable */
            border-radius: 8px; /* Optional: slight rounding */
        }

        .sidebar-logo i {
            font-size: 3.5rem; /* Adjusted size */
            color: var(--sidebar-icon-color); /* Use variable */
            margin-bottom: 0.5rem;
        }

        .sidebar-logo .logo-text {
            font-size: 1.75rem; /* Adjusted size */
            font-weight: 700; /* Bolder */
            color: var(--sidebar-text-color); /* Use variable */
            font-family: 'Inter', sans-serif;
        }

        .sidebar .nav-menu { /* New class for the nav itself */
            flex-grow: 1; /* Allows nav to take available space */
            overflow-y: auto; /* Scroll if content overflows */
            padding: 0 1rem; /* Horizontal padding for nav links */
        }

        .sidebar .nav-link {
            font-size: 1rem; /* Slightly smaller for a cleaner look */
            font-weight: 500; /* Medium weight */
            padding: 0.875rem 1.25rem; /* Adjusted padding */
            color: var(--sidebar-text-color) !important; /* Ensure high specificity */
            opacity: 0.85;
            display: flex; /* For icon and text alignment */
            align-items: center;
            border-radius: 8px; /* Rounded corners */
            margin-bottom: 0.5rem; /* Space between items */
            transition: background-color 0.2s ease, color 0.2s ease, opacity 0.2s ease, padding-left 0.2s ease;
            position: relative; /* For pseudo-elements if needed */
        }
        .sidebar .nav-link i.bi { /* Target Bootstrap Icons specifically */
            font-size: 1.25rem; /* Icon size */
            margin-right: 0.875rem; /* Space between icon and text */
            color: var(--sidebar-icon-color); /* Use variable */
            opacity: 0.9;
            transition: color 0.2s ease, opacity 0.2s ease;
        }


        .sidebar .nav-link.active {
            background-color: var(--sidebar-active-bg);
            color: var(--sidebar-text-color) !important; /* Ensure text color remains for active */
            font-weight: 600; /* Bolder for active */
            opacity: 1;
        }
        .sidebar .nav-link.active i.bi {
            color: var(--accent-color); /* Highlight icon with accent color on active */
            opacity: 1;
        }
        [data-bs-theme="light"] .sidebar .nav-link.active i.bi {
            color: #ffffff; /* White icon on light theme active for better contrast with accent bg */
        }


        .sidebar .nav-link:hover {
            background-color: var(--sidebar-hover-bg);
            color: var(--sidebar-text-color) !important;
            opacity: 1;
            padding-left: 1.5rem; /* Subtle indent on hover */
        }
        .sidebar .nav-link:hover i.bi {
            opacity: 1;
        }

        /* Removed .menu-text and .menu-icon specific hover styles for a cleaner approach */

        .sidebar .theme-toggle-wrapper { /* New wrapper */
            padding: 0 1.5rem; /* Horizontal padding */
            margin-top: auto; /* Pushes to the bottom */
        }

        .sidebar .theme-toggle {
            font-size: 1rem;
            font-weight: 500;
            padding: 0.875rem 1.25rem;
            color: var(--sidebar-text-color) !important;
            opacity: 0.85;
            display: flex;
            align-items: center;
            border-radius: 8px;
            margin-top: 1rem; /* Space above toggle */
            margin-bottom: 0.5rem; /* Consistent with nav-links */
            background-color: transparent; /* Default transparent */
            transition: background-color 0.2s ease, color 0.2s ease, opacity 0.2s ease;
        }
        .sidebar .theme-toggle:hover {
            background-color: var(--sidebar-hover-bg);
            opacity: 1;
        }
        .sidebar .theme-toggle i.bi {
            font-size: 1.25rem;
            margin-right: 0.875rem;
            color: var(--sidebar-icon-color);
        }


        /* Main Content */
        .main-content {
            margin-left: 25%;
            width: 75%;
            min-height: 100vh;
            flex-direction: column;
            padding: 2rem; /* Standardized padding */
            box-sizing: border-box;
            opacity: 0;
            transition: opacity 0.5s ease-in, margin-left 0.3s ease, width 0.3s ease; /* Added margin/width transition */
        }

        .main-content.loaded {
            opacity: 1;
        }

        /* Responsive Adjustments */
        @media (max-width: 991.98px) { /* Adjusted breakpoint for better tablet handling */
            .sidebar {
                width: 280px; /* Fixed width for tablets if preferred, or keep 25% */
            }
            .main-content {
                margin-left: 280px;
                width: calc(100% - 280px);
            }
             .loading-screen { left: 280px; width: calc(100% - 280px); }
        }

        @media (max-width: 767.98px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative; /* Becomes part of normal flow */
                box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Bottom shadow for mobile nav */
                padding: 1rem 0;
            }
            .sidebar-logo-wrapper { margin-bottom: 1rem; }
            .sidebar .nav-menu { padding: 0 0.5rem; } /* Less padding on mobile */
            .sidebar .nav-link { margin-bottom: 0.25rem; padding: 0.75rem 1rem; }
            .sidebar .theme-toggle-wrapper { padding: 0 0.5rem; }
            .sidebar .theme-toggle { margin-top: 0.5rem; }

            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 1.5rem 1rem; /* Adjusted mobile padding */
            }
            .loading-screen { left: 0; width: 100%; }
        }

        /* Other styles (page-title, transaction-item, etc.) mostly unchanged unless directly conflicting */
        .page-title {
            font-size: 2.5rem !important; /* Adjusted for better balance */
            font-weight: 700;
            text-align: left; /* Usually better for page titles */
            padding-top: 0;
            padding-bottom: 0;
            margin-bottom: 2rem;
            color: var(--accent-color);
        }

        /* ... (rest of your existing CSS for .transaction-item, .footer, .balance-box, .divider, .modal, .alert, .btn-outline-primary etc. would go here) ... */
        /* Ensure these styles also use theme variables where appropriate if not already done */

        /* Example for .btn-primary to ensure it uses theme variables correctly */
        .btn-primary {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
            color: var(--sidebar-text-color); /* Assuming white/light text on accent bg */
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .btn-primary:hover {
            background-color: var(--accent-color-hover);
            border-color: var(--accent-color-hover);
        }
        [data-bs-theme="dark"] .btn-primary {
            color: var(--text-color); /* Or a specific dark theme button text color */
        }


        /* Footer Styles - ensure it's correctly positioned if fixed */
        .footer-container {
            position: fixed; /* This can cause overlap if content is short */
            bottom: 0;
            left: 25%; /* Adjust if sidebar width changes */
            right: 0;
            z-index: 900; /* Below sidebar */
            transition: left 0.3s ease;
        }
        .footer {
            background: var(--footer-bg);
            color: var(--footer-text);
            padding: 1rem;
            text-align: center;
            font-family: 'Inter', sans-serif; /* Changed from Poppins */
            transition: background 0.3s ease, color 0.3s ease;
            width: 100%;
            border-top: 1px solid rgba(var(--accent-color-rgb), 0.1);
        }
         @media (max-width: 767.98px) {
            .footer-container {
                position: relative; /* Static on mobile */
                left: 0;
                width: 100%;
            }
        }
        /* ... (rest of your styles) ... */

    </style>

    {% block styles %}
    {% endblock %}

    <script>
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-bs-theme', savedTheme);
    </script>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Menu -->
        <div class="col-md-3 sidebar vh-100 d-flex flex-column p-0"> <!-- Removed default Bootstrap padding -->
            <div class="sidebar-logo-wrapper">
                <a class="navbar-brand d-block" href="/fe/account"> <!-- Make logo clickable -->
                    <div class="sidebar-logo">
                        <i class="bi bi-wallet2"></i>
                        <span class="logo-text">VWallet</span>
                    </div>
                </a>
            </div>

            <nav class="nav flex-column nav-menu"> <!-- Added nav-menu class -->
                <a class="nav-link{% if page == 'account overview' %} active{% endif %}" href="/fe/account">
                    <i class="bi bi-house-door"></i>
                    <span>Account Overview</span>
                </a>
                <a class="nav-link{% if page == 'deposits' %} active{% endif %}" href="/fe/deposits">
                    <i class="bi bi-arrow-down-circle"></i> <!-- Changed icon -->
                    <span>Deposit Cash</span>
                </a>
                <a class="nav-link{% if page == 'withdrawals' %} active{% endif %}" href="/fe/withdrawals">
                    <i class="bi bi-arrow-up-circle"></i> <!-- Changed icon -->
                    <span>Withdraw Cash</span>
                </a>
                <a class="nav-link{% if page == 'transactions' %} active{% endif %}" href="/fe/transactions">
                    <i class="bi bi-list-ul"></i>
                    <span>Transactions</span>
                </a>
                <a class="nav-link{% if page == 'cards' %} active{% endif %}" href="/fe/cards">
                    <i class="bi bi-credit-card"></i>
                    <span>Cards</span>
                </a>
                <a class="nav-link{% if page == 'contacts' %} active{% endif %}" href="/fe/contacts"> <!-- Fixed active class condition -->
                    <i class="bi bi-people"></i>
                    <span>Contacts</span>
                </a>
                <a class="nav-link" href="/fe/logout" id="logout-btn">
                    <i class="bi bi-box-arrow-right"></i>
                    <span>Logout</span>
                </a>
            </nav>

            <div class="theme-toggle-wrapper">
                <a class="nav-link theme-toggle" href="#" id="theme-toggle">
                    <i class="bi bi-moon"></i>
                    <span>Toggle Theme</span>
                </a>
            </div>
        </div>

        <!-- Loading Screen -->
        <div class="loading-screen" id="loading-screen" aria-label="Loading content, please wait">
            <i class="bi bi-arrow-repeat loading-spinner"></i>
        </div>

        <!-- Main Content -->
        <div class="main-content loading" id="main-content">
            {% block content %}
            {% endblock %}
        </div>
    </div>
</div>

{% block modals %}
{% endblock %}

<script>
    // --- Your existing JavaScript ---
    // (No changes made to the JS logic itself, only to CSS and HTML structure of sidebar)
      async function initializeBaseScripts() {
        try {
            // Base requirements
            if (typeof jQuery === 'undefined' || typeof bootstrap === 'undefined') {
                throw new Error('jQuery or Bootstrap not loaded');
            }

            if (!token) {
                // Redirect to login if no token, ensure main content is hidden or shows login message
                const mainContentEl = document.getElementById('main-content');
                if (mainContentEl) mainContentEl.innerHTML = '<p style="text-align:center; padding-top: 2rem;">Please log in to continue.</p>';
                window.location.href = `${FE_BASE}/login?invalid-token`;
                return; // Stop further execution
            }

            // Fetch user data early
            await refreshUserData();


            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            updateToggleIcon(savedTheme);

            // Page specific resources - ensure this event is reliably dispatched
            const pageContentLoaded = new Promise(resolve => {
                document.addEventListener('pageContentLoaded', resolve, { once: true });
                // Fallback timeout if the event is never fired
                setTimeout(() => {
                    console.warn('pageContentLoaded event timeout');
                    resolve();
                }, 3000); // Reduced timeout
            });

            await pageContentLoaded;


            // Page loaded
            const loadingScreen = document.getElementById('loading-screen');
            const mainContent = document.getElementById('main-content');

            if (loadingScreen) loadingScreen.classList.add('hidden');
            if (mainContent) {
                 mainContent.classList.remove('loading');
                 mainContent.classList.add('loaded');
            }

            // Ensure loading screen is removed from DOM after transition
            if (loadingScreen) {
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500); // Match CSS transition duration
            }

        } catch (error) {
            console.error('Error initializing base scripts:', error);
            const loadingScreen = document.getElementById('loading-screen');
            const mainContent = document.getElementById('main-content');
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                 setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }
            if (mainContent) {
                mainContent.classList.remove('loading');
                mainContent.classList.add('loaded');
                // Optionally display an error message in main content
                // mainContent.innerHTML = `<p class="text-danger text-center">Error loading page content.</p>`;
            }
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        initializeBaseScripts(); // Call the async function
    });


    // User data
    const userData = {};

    // let uname, uid, uemail, uphone, ubalance, uavatar, ustatus; // These seem unused globally, userData object is used

    async function refreshUserData() {
        if (!token) { // Added check here as well
            console.warn('No token found, skipping user data refresh.');
            return;
        }
        try {
            const userResponse = await fetch(`${API_BASE}/users/me`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            });

            if (!userResponse.ok) {
                const errorData = await userResponse.json().catch(() => ({ detail: 'Failed to parse error response from server.' }));
                console.error('Failed to fetch user data:', userResponse.status, errorData);
                // Avoid alert here as it can be disruptive during initial load.
                // Consider a less intrusive error display if this is critical path for UI.
                if (userResponse.status === 401 || userResponse.status === 403) {
                     document.cookie = 'access_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT'; // Clear cookie
                     window.location.href = `${FE_BASE}/login?session-expired`;
                }
                // throw new Error(errorData.detail || `HTTP error ${userResponse.status}`);
                return; // Allow page to load partially if user data isn't critical for all views
            }

            const udata = await userResponse.json();
            if (!udata || typeof udata.username !== 'string') { // Basic validation
                console.error('Invalid user data structure received:', udata);
                // throw new Error('Invalid user data format.');
                return;
            }

            userData.username = udata.username;
            userData.id = udata.id;
            userData.email = udata.email;
            userData.phone = udata.phone_number;
            userData.balance = parseFloat(udata.balance).toFixed(2); // Ensure it's a number then format
            userData.avatar = udata.avatar;
            userData.status = udata.status;
            console.log(`User data successfully fetched for ${userData.username}.`);
        } catch (error) {
            console.error('Exception during refreshUserData:', error);
            // Avoid alert here too.
            // window.location.href = `${FE_BASE}/login?data-error`; // This might be too aggressive
        }
    }

    // Removed duplicate DOMContentLoaded for refreshUserData, it's called in initializeBaseScripts

    // Theme Toggle
    const themeToggleButton = document.getElementById('theme-toggle');
    if (themeToggleButton) {
        themeToggleButton.addEventListener('click', (e) => {
            e.preventDefault();
            const currentTheme = document.documentElement.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateToggleIcon(newTheme);
        });
    }


    function updateToggleIcon(theme) {
        const themeToggleElement = document.querySelector('#theme-toggle');
        if (themeToggleElement) {
            const icon = themeToggleElement.querySelector('i');
            if (icon) {
                if (theme === 'dark') {
                    icon.classList.remove('bi-moon');
                    icon.classList.add('bi-sun');
                } else {
                    icon.classList.remove('bi-sun');
                    icon.classList.add('bi-moon');
                }
            }
        }
    }
    // Initial call to set icon correctly on page load
    // This is already handled in initializeBaseScripts, so can be removed from here if preferred
    // document.addEventListener('DOMContentLoaded', () => {
    //     const initialTheme = localStorage.getItem('theme') || 'light';
    //     updateToggleIcon(initialTheme);
    // });
</script>

{% block scripts %}
{% endblock %}


</body>
</html>